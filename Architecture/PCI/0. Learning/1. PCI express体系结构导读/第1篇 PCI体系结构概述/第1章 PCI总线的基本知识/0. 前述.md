PCI总线作为处理器系统的局部总线主要目的是**为了连接外部设备**而**不是作为处理器的系统总线连接Cache和主存储器**. 但是PCI总线、系统总线和处理器体系结构之间依然存在着紧密的联系. 

PCI总线作为系统总线的延伸其设计考虑了许多与处理器相关的内容如处理器的Cache共享一致性和数据完整性以及如何与处理器进行数据交换等一系列内容. 其中Cache共享一致性和数据完整性是现代处理器局部总线的设计的重点和难点也是本书将重点讲述的主题之一. 

独立地研究PCI总线并不可取因为PCI总线仅是处理器系统的一个组成部分. 深入理解PCI总线需要了解一些与处理器体系结构相关的知识. 这些知识是本书所侧重描述的同时也是PCI总线规范所忽略的内容. 脱离实际的处理器系统不容易也不可能深入理解PCI总线规范. 

对于今天的读者来说PCI总线提出的许多概念略显过时也有许多不足之处. 但是在当年PCI总线与之前的存在其他并行局部总线如ISA、EISA和MCA总线相比具有许多突出的优点是一个全新的设计. 

(1) PCI总线空间与处理器空间隔离

PCI设备具有独立的地址空间即**PCI总线地址空间该空间与存储器地址空间通过HOST主桥隔离**. **处理器需要通过HOST主桥才能访问PCI设备**而**PCI设备需要通过HOST主桥才能访问主存储器**. 在HOST主桥中含有许多缓冲这些缓冲使得处理器总线与PCI总线工作在各自的时钟频率中彼此互不干扰. HOST主桥的存在也使得PCI设备和处理器可以方便地共享主存储器资源. 

**处理器访问PCI设备**时必须**通过HOST主桥进行地址转换**; 而**PCI设备访问主存储器**时也需要**通过HOST主桥进行地址转换**. HOST主桥的一个重要作用就是**将处理器访问的存储器地址转换为PCI总线地址**. PCI设备使用的地址空间是属于PCI总线域的而与存储器地址空间不同. 

x86处理器对PCI总线域与存储器域的划分并不明晰这也使得许多程序员并没有准确地区分PCI总线域地址空间与存储器域地址空间. 而本书将反复强调存储器地址和PCI总线地址的区别因为这是理解PCI体系结构的重要内容. 

PCI规范并没有对HOST主桥的设计进行约束. 每一个处理器厂商使用的HOST主桥其设计都不尽相同. HOST主桥是联系PCI总线与处理器的核心部件掌握HOST主桥的实现机制是深入理解PCI体系结构的前提. 

本书将以Freescale的PowerPC处理器和Intel的x86处理器为例说明各自HOST主桥的实现方式值得注意的是本书涉及的PowerPC处理器仅针对Freescale的PowerPC处理器而不包含IBM和AMCC的Power和PowerPC处理器. 而且如果没有特别说明本书中涉及的x86处理器特指Intel的处理器而不是其他厂商的x86处理器. 

(2) 可扩展性

PCI总线具有很强的扩展性. 在PCI总线中**HOST主桥可以直接推出一条PCI总线**这条总线也是该HOST主桥的所管理的第一条PCI总线该总线还可以通过PCI桥扩展出一系列PCI总线并以HOST主桥为根节点形成1颗PCI总线树. 这些PCI总线都可以连接PCI设备但是**在1颗PCI总线树上最多只能挂接256个PCI设备(包括PCI桥)**. 

在**同一条PCI总线上的设备间可以直接通信**并不会影响其他PCI总线上设备间的数据通信. 隶属于同一颗PCI总线树上的PCI设备也可以直接通信但是需要通过PCI桥进行数据转发. 

PCI桥是PCI总线的一个重要组成部件该部件的存在使得PCI总线极具扩展性. PCI桥也是有别于其他局部总线的一个重要部件. 在“以HOST主桥为根节点”的PCI总线树中每一个PCI桥下也可以连接一个PCI总线子树PCI桥下的PCI总线仍然可以使用PCI桥继续进行总线扩展. 

PCI桥可以管理这个PCI总线子树**PCI桥的配置空间**含有一系列管理PCI总线子树的配置寄存器. 在PCI桥的两端分别连接了两条总线分别是上游总线(Primary Bus)和下游总线(Secondary Bus). 其中与处理器距离较近的总线被称为上游总线另一条被称为下游总线. 这两条总线间的通信需要通过PCI桥进行. PCI桥中的许多概念被PCIe总线采纳理解PCI桥也是理解PCIe体系结构的基础. 

(3) 动态配置机制

PCI设备使用的地址可以根据需要由系统软件动态分配. PCI总线使用这种方式合理地解决了设备间的地址冲突从而实现了“即插即用”功能. 从而PCI总线不需要使用ISA或者EISA接口卡为解决地址冲突而使用的硬件跳线. 

每一个PCI设备都有独立的配置空间在配置空间中含有该设备在PCI总线中使用的基地址系统软件可以动态配置这个基地址从而保证每一个PCI设备使用的物理地址并不相同. PCI桥的配置空间中含有其下PCI子树所能使用的地址范围. 

(4) 总线带宽

PCI总线与之前的局部总线相比极大提高了数据传送带宽32位/33MHz的PCI总线可以提供132MB/s的峰值带宽而64位/66MHz的PCI总线可以提供的峰值带宽为532MB/s. 虽然PCI总线所能提供的峰值带宽远不能和PCIe总线相比但是与之前的局部总线ISA、EISA和MCA总线相比仍然具有较大的优势. 

ISA总线的最高主频为8MHz位宽为16其峰值带宽为16MB/s; EISA总线的最高主频为8.33MHz位宽为32其峰值带宽为33MB/s; 而MCA总线的最高主频为10MHz最高位宽为32其峰值带宽为40MB/s. PCI总线提供的峰值带宽远高于这些总线. 

(5) 共享总线机制

PCI设备通过仲裁获得PCI总线的使用权后才能进行数据传送在PCI总线上进行数据传送并不需要处理器进行干预. 

PCI总线仲裁器不在PCI总线规范定义的范围内也不一定是HOST主桥和PCI桥的一部分. 虽然绝大多数HOST主桥和PCI桥都包含PCI总线仲裁器但是在某些处理器系统的设计中也可以使用独立的PCI总线仲裁器. 如在PowerPC处理器的HOST主桥中含有PCI总线仲裁器但是用户可以关闭这个总线仲裁器而使用独立的PCI总线仲裁器. 

PCI设备使用共享总线方式进行数据传递在同一条总线上所有PCI设备共享同一总线带宽这将极大地影响PCI总线的利用率. 这种机制显然不如PCIe总线采用的交换结构但是在PCI总线盛行的年代半导体的工艺、设计能力和制作成本决定了采用共享总线方式是当时的最优选择. 

(6) 中断机制

PCI总线上的设备可以通过四根中断请求信号INTA~D#向处理器提交中断请求. 与ISA总线上的设备不同PCI总线上的设备可以共享这些中断请求信号不同的PCI设备可以将这些中断请求信号“线与”后与中断控制器的中断请求引脚连接. PCI设备的配置空间记录了该设备使用这四根中断请求信号的信息. 

PCI总线进一步提出了MSI(Message Signal Interrupt)机制该机制使用存储器写总线事务传递中断请求并可以使用x86处理器FSB(Front Side Bus)总线提供的Interrupt Message总线事务从而提高了PCI设备的中断请求效率. 

虽然从现代总线技术的角度上看PCI总线仍有许多不足之处但也不能否认PCI总线已经获得了巨大的成功不仅x86处理器将PCI总线作为标准的局部总线连接各类外部设备PowerPC、MIPS和ARM[1]处理器也将PCI总线作为标准局部总线. 除此之外基于PCI总线的外部设备如以太网控制器、声卡、硬盘控制器等也已经成为主流. 