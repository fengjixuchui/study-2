
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->
- [1. 配置空间概述](#1-配置空间概述)
- [1. 配置空间概述](#1-配置空间概述)
  - [1.1. 基本配置空间](#11-基本配置空间)
  - [1.2. 中断和PM Capability](#12-中断和pm-capability)
  - [1.3. 扩展配置空间](#13-扩展配置空间)
  - [1.4. 配置空间的访问](#14-配置空间的访问)
  - [1.5. Capability结构链表](#15-capability结构链表)
  - [1.6. 多种Capability](#16-多种capability)
- [2. Power Management Capability结构](#2-power-management-capability结构)
- [3. PCI Express Capability结构](#3-pci-express-capability结构)
- [4. PCI Express Extended Capability结构](#4-pci-express-extended-capability结构)
- [4. PCI Express Extended Capability结构](#4-pci-express-extended-capability结构)
<!-- /code_chunk_output -->

# 1. 配置空间概述

## 1.1. 基本配置空间

前面讲述了**PCI设备**使用的**基本配置空间**. 这个基本配置空间共由**64个字节**组成其地址范围为`0x00~0x3F`这**64个字节**是**所有PCI设备必须支持(！！！PCI设备**)的. 事实上**许多PCI设备**也**仅支持**这64个配置寄存器. 

## 1.2. 中断和PM Capability

此外 `PCI/PCI-X` 和 PCIe 设备还扩展了`0x40~0xFF`(！！！)这段**配置空间**. 在这段空间**主要存放**一些**与 MSI 或者 MSI-X 中断机制**和**电源管理相关的Capability结构**.
> 其中**所有能够提交中断请求**的PCIe设备**必须支持 MSI或者 MSI-X Capability 结构(！！！**). 

## 1.3. 扩展配置空间

**PCIe设备**还支持`0x100~0xFFF`(！！！)这段**扩展配置空间**. PCIe设备使用的扩展配置空间**最大为4KB(其实是一共的配置空间大小！！！**), 在PCIe总线的扩展配置空间中存放**PCIe设备所独有**的一些**Capability结构**而**PCI设备不能使用**这段空间. 

## 1.4. 配置空间的访问

* 在 **x86** 处理器中使用 `CONFIG_ADDRESS` **寄存器**与 `CONFIG_DATA` **寄存器**访问 PCIe 配置空间的 `0x00~0xFF` 而使用**ECAM方式**访问 `0x000~0xFFF` 这段空间;
* 在 **PowerPC** 处理器中可以使用 `CFG_ADDR` 和 `CFG_DATA` 寄存器访问 `0x000~0xFFF` 详见 `2.2` 节. 

## 1.5. Capability结构链表

`PCI-X` 和 PCIe 总线规范要求其**设备必须支持 Capabilities 结构**. 在**PCI总线**的**基本配置空间**中包含一个**Capabilities Pointer寄存器(！！！**), 该寄存器存放 Capabilities 结构**链表的头指针**. 在一个PCIe设备中可能含有**多个 Capability 结构**, 这些寄存器组成一个链表, 其结构如图4‑14所示. 

![config](./images/12.png)

其中**每一个Capability**结构都有**唯一的ID号**, 每一个Capability寄存器都有**一个指针**, 这个指针指向下一个Capability结构, 从而组成一个**单向链表结构**, 这个链表的**最后一个Capability**结构的**指针为0**. 

## 1.6. 多种Capability

**一个PCIe设备**可以包含**多种Capability结构(！！！**)包括与**电源管理相关**、与**PCIe总线相关**的结构、与**中断请求相关**的Capability结构、**PCIe Capability结构**和PCIe**扩展的Capability**结构.

在第6章详细将讨论MSI/MSI-X Capability结构. 在**PCIe总线规范**中定义了**较多的Capability结构**这些结构适用于不同的应用场合在一个指定的PCIe设备中并不一定支持本篇中涉及的所有Capability结构. 系统软件程序员也不需要完全掌握PCIe总线规范定义的这些Capability结构. 

# 2. Power Management Capability结构

# 3. PCI Express Capability结构

PCI Express Capability 结构存放一些和PCIe总线相关的信息, 包括PCIe链路和插槽的信息. 有些PCIe设备不一定实现结构中所有寄存器, 或者并没有提供这些配置寄存器供系统软件访问.

PCI Express Capability结构的部分寄存器及其相应字段与硬件的具体实现细节相关, 本节仅介绍其中一些系统软件程序员需要了解的字段.

该结构中, Cap ID字段为PCI Express Capability结构使用的ID号, 其值为0x10. 而Next Capability字段存放下一个Capability寄存器的地址. PCI Express Capability结构如图.

![config](./images/13.png)

.......


# 4. PCI Express Extended Capability结构


