



基于PCI的传统计算机系统

![2021-09-29-15-40-56.png](./images/2021-09-29-15-40-56.png)


PCIe 采用树形拓扑结构, 如下图.

基于PCIe计算机系统:

![2021-09-29-15-41-32.png](./images/2021-09-29-15-41-32.png)

整个PCIe拓扑结构是一个树形结构. Root Complex(RC)是树的根, 它为CPU代言, 与整个计算机系统其他部分通信, 比如CPU通过它访问内存, 通过它访问PCIe系统中的设备. 

> 也就是说 CPU 都是通过 RC 与其他组件通信的.

PCIe Spec 并没有规定 RC 的组成. 只需了解: 它一般实现了一条内部PCIe总线(BUS 0), 以及通过若干个PCIe bridge, 扩展出一些PCIe Port.

Root Complex内部总线:

![2021-09-29-15-47-01.png](./images/2021-09-29-15-47-01.png)

> 注意各个部件的名字


PCIe Switch:

![2021-09-29-15-49-29.png](./images/2021-09-29-15-49-29.png)


Switch内部总线结构:

![2021-09-29-15-50-29.png](./images/2021-09-29-15-50-29.png)





![2021-09-29-16-20-42.png](./images/2021-09-29-16-20-42.png)


lspci命令详解: https://www.cnblogs.com/machangwei-8/p/10403495.html

```
# lspci -vt
-[0000:00]-+-00.0  Intel Corporation Device 9b43
           +-01.0-[01]--+-00.0  NVIDIA Corporation GK208B [GeForce GT 730]
           |            \-00.1  NVIDIA Corporation GK208 HDMI/DP Audio Controller
           +-02.0  Intel Corporation CometLake-S GT2 [UHD Graphics 630]
           +-08.0  Intel Corporation Xeon E3-1200 v5/v6 / E3-1500 v5 / 6th/7th/8th Gen Core Processor Gaussian Mixture Model
           +-12.0  Intel Corporation Comet Lake PCH Thermal Controller
           +-14.0  Intel Corporation Comet Lake USB 3.1 xHCI Host Controller
           +-14.2  Intel Corporation Comet Lake PCH Shared SRAM
           +-15.0  Intel Corporation Comet Lake PCH Serial IO I2C Controller #0
           +-16.0  Intel Corporation Comet Lake HECI Controller
           +-17.0  Intel Corporation Device 06d2
           +-1b.0-[02]----00.0  Samsung Electronics Co Ltd Device a809
           +-1c.0-[03-04]----00.0-[04]--
           +-1f.0  Intel Corporation Device 0687
           +-1f.3  Intel Corporation Comet Lake PCH cAVS
           +-1f.4  Intel Corporation Comet Lake PCH SMBus Controller
           +-1f.5  Intel Corporation Comet Lake PCH SPI Controller
           \-1f.6  Intel Corporation Ethernet Connection (11) I219-LM
```

上面的没有打印 bus 非0 的信息

```
# lspci
...
01:00.0 VGA compatible controller: NVIDIA Corporation GK208B [GeForce GT 730] (rev a1)
01:00.1 Audio device: NVIDIA Corporation GK208 HDMI/DP Audio Controller (rev a1)
02:00.0 Non-Volatile memory controller: Samsung Electronics Co Ltd Device a809
03:00.0 PCI bridge: Texas Instruments XIO2001 PCI Express-to-PCI Bridge
```

RC 本身并不表现为一个 device

`00:00.0` 是 RC 中的 Host bridge

```
# lspci -s 00:00.0
00:00.0 Host bridge: Intel Corporation Device 9b43 (rev 05)
```

`00.01.0` 是 RC 中的 PCI bridge

```
# lspci -s 00:01.0
00:01.0 PCI bridge: Intel Corporation 6th-10th Gen Core Processor PCIe Controller (x16) (rev 05)
```

bus 相同, device 不同的多个 `PCI bridge` 可能就是一个 Switch.

