
物理层是整个PCIe协议层的最底层，用来跑腿的。无论是TLP还是DLLP，到最后都需要物理层来进行实实在在的物理信号传输。因此，有必要深入基层，了解一下物理层在做什么。

物理层由电气模块和逻辑模块组成。电气模块方面，我们知道PCIe是采用串行总线传输数据，使用的是差分信号，即用两根信号线上的电平差表示0或1。与单端信号传输相比，差分信号抗干扰能力强，能提供更宽的带宽（跑得更快）。打个比方，假设用两个信号线上电平差表示0和1，具体来讲，差值大于0，表示1；差值小于0，表示0。如果传输过程中存在干扰，两个线上加了近乎同样大小的干扰电平，两者相减，差值几乎不变，并不会影响信号传输。但对单端信号传输来说，就很容易受干扰，比如0～1V表示0,1～3V表示1，一个本来是0.8V的电压，加入干扰，变成1.5V，相当于0变成1，数据就出错了。抗干扰能力强，因而可以用更快的速度进行数据传输，从而提供更宽的带宽（关于PCIe速度，可参看5.1节）。

关于电气模块更多详细内容，可以去读PCIe规范。对于SSD开发人员（尤其是固件开发者）来说，我觉得记住“串行总线，差分信号”就可以了，PCIe的快是因为在物理传输上使用了这两大技术。

我们重点看看物理层的逻辑模块，如图5-57所示。

物理层中发送端逻辑子模块:

![2021-11-13-19-04-26.png](./images/2021-11-13-19-04-26.png)

* 物理层从数据链路层获得TLP或者是DLLP，然后放到TxBuffer里。

* 物理层给TLP或者DLLP加入头（Start code）和尾（End code、Gen 3没有尾巴）；给每个TLP或者DLLP加上边界符号，这样接收端就能把TLP或者DLLP区分开。

* 第一节提到，PCIe链路上可能有若干个Lane。在物理层，TLP或者DLLP数据会分派到每个Lane上独立传输。这个过程叫Byte Stripping，类似于串并转换。

* 数据进入每条Lane后，分别加串扰（Scramble），目的是减少电磁干扰（EMI），手段是让数据与随机数据进行异或操作，输出伪随机数据，然后再发送出去。

* 加扰后的数据进行8/10编码（Gen3是128/130编码）。8/10编码是IBM的专利，目的主要有：让数据流中的0和1个数相当，保持直流平衡；嵌入时钟信息，PCIe不需要专门的时钟进行信号传输。

* 最后进行并串转换，发送到串行物理总线上去。

接收端逻辑模块如图5-58所示。

物理层中接收端逻辑子模块:

![2021-11-13-19-04-33.png](./images/2021-11-13-19-04-33.png)

接收端逆向操作，不再赘述。

PCIe的三层，从上到下，依次为事务层、数据链路层和物理层。每层都有自己的数据包定义：事务层产生TLP，经过数据链路层和物理层传输给接收方；数据链路层产生DLLP，经过物理层传输到对方；物理层，不仅仅为上层TLP和DLLP做嫁衣，其实它也有自己的数据包定义，称为Ordered Sets，简称OS。

TLP用以传输应用层或者命令层（事务层的顶头上司）数据，DLLP用以ACK/NAK、流控和电源管理等，OS的功能是物理层用以管理链路的，比如链路训练（LinkTraining）、改变链路电源状态等。表5-8是PCIe中OS列表。

Ordered Sets列表:

![2021-11-13-19-04-39.png](./images/2021-11-13-19-04-39.png)

