
绝大多数的总线或者接口, 都是采用分层实现的

PCIe 分层结构:

![2021-11-09-21-28-55.png](./images/2021-11-09-21-28-55.png)

PCIe 定义了三层：事务层（Transaction Layer）、数据链路层（Data Link Layer）和物理层（Physical Layer, 包括逻辑子模块和电气子模块）.

每层职能是不同的, 但下层总是为上层服务的.

分层设计的一个好处是, 如果层次分得够好, 接口版本升级时, 硬件设计可能只需要改动某一层, 其他层可以保持不动.

PCIe 传输的数据从上到下, 都是以数据包（Packet）的形式传输的, 每层数据包都是有其固定的格式.

事务层的主要职责是创建（发送）或者解析（接收）TLP（Transaction Layer Packet）、流量控制、QoS、事务排序等.

数据链路层的主要职责是创建（发送）或者解析（接收）DLLP（Data Link Layer Packet）、Ack/Nak 协议（链路层检错和纠错）、流控、电源管理等.

物理层的主要职责是处理所有的 Packet 数据物理传输, 发送端数据分发到各个 Lane 传输（Stripe）, 接收端把各个 Lane 上的数据汇总起来（De-stripe）, 每个 Lane 上加扰（Scramble, 目的是让 0 和 1 分布均匀, 去除信道的电磁干扰 EMI）和去扰（De-scramble）, 以及 8/10 或者 128/130 编码解码等.

PCIe 各层次细节图:

![2021-11-09-21-32-21.png](./images/2021-11-09-21-32-21.png)

数据从上到下, 一层层打包, 上层打包完的数据, 作为下层的原始数据, 再打包. 就像人穿衣服一样, 穿了内衣穿衬衫, 穿了衬衫穿外套.

Data 是事务层上层（诸如命令层、NVMe 层）给的数据, 事务层给它头上加个 Header, 然后尾巴上再加个 CRC 校验, 就构成了一个 TLP. 这个 TLP 下传到数据链路层, 又被数据链路层在头上加了个包序列号（Sequence Number, SN）, 尾巴上再加个 CRC 校验, 然后下传到物理层. 物理层为其头上加个 Start, 尾巴上加个 End 符号, 把这些数据分派到各个 Lane 上, 然后在每个 Lane 上加扰码, 经 8/10 或 128/130 编码, 最后通过物理传输介质传输给接收方, 如图 5-13 所示.

发送方打包 TLP 过程:

![2021-11-09-21-35-46.png](./images/2021-11-09-21-35-46.png)

接收方物理层是最先接收到这些数据的, 掐头（Start）去尾（End）, 然后交由上层. 在数据链路层, 校验序列号和 LCRC, 如果没问题, 剥掉序列号和 LCRC, 往事务层走；如果校验出差, 通知对方重传. 在事务层, 校验 ECRC, 有错, 数据抛弃；没错, 去掉 ECRC, 获得数据. 整个过程犹如脱衣睡觉, 外套脱了, 衬衫脱了, 内衣也脱了, 光溜溜钻进被窝, 如图 5-14 所示.

接收方解包 TLP 过程:

![2021-11-09-21-35-54.png](./images/2021-11-09-21-35-54.png)

和 PCI 数据裸奔不同, PCIe 的数据是穿衣服的. PCIe 数据以 Packet 的形式传输, 比起 PCI 冷冰冰的数据, PCIe 的数据是鲜活有生命的.

**每个 Endpoint** 都需要实现这三层, **每个 Switch 的 Port** 也需要实现这三层.

> 所以一个端口算一个 lspci device? 一个 Switch 有多个 device(一个 port 算一个)?

RC、Switch 和 EP 都要实现三层:

![2021-11-09-21-36-08.png](./images/2021-11-09-21-36-08.png)

如图 5-15 所示, 如果 RC 要与 EP1 通信, 中间要经历怎样的一个过程?

如果把前述的数据发送和接收过程叫作穿衣和脱衣, 那么, RC 与 EP1 数据传输过程中, 则存在好几次这样穿衣脱衣的过程：RC 帮数据穿好衣服, 发送给 Switch 的上游端口, A 为了知道该笔数据发送给谁, 就需要脱掉该数据的衣服, 找到里面的地址信息. 衣服脱光后, Switch 发现它是往 EP1 的, 又帮它换了身新衣服, 发送给端口 B. B 又不嫌麻烦的脱掉它的衣服, 换上新衣服, 最后发送给 EP1, 如图 5-16 所示.

RC 和 EP 通信:

![2021-11-09-21-36-17.png](./images/2021-11-09-21-36-17.png)

Switch 的主要功能是转发数据, 为什么还需要实现事务层? Switch 必须实现这三层, 因为**数据的目的地信息是在 TLP 中**的, 如果不实现这一层, 就无法知道目的地址, 也就无法实现数据寻址路由.