
这两部分都在 `Device Control Register`（设备控制寄存器）里，如图5-66所示，分别由 `bit[14:12]` 和 `bit[7:5]` 控制。

设备控制寄存器:



# Maximum Payload Size(MPS）

控制一个 **TLP** 可以传输的**最大数据长度**。作为接收方，必须能处理跟 MPS 设定大小相同的 TLP 数据包，作为传输方，不允许创建超过 MPS 设定的 TLP 数据包。

PCIe 协议允许一个**最大**的 **Payload** 可以到**4KB**，但是规定了在**整个传输路径**上的**所有设备**，都必须使用**相同的 MPS 设置**，同时**不能超过**该路径上**任何一个设备**的 `MPS` 能力值。也就是说，`MPS Capability` 高的设备要迁就低的设备。以 PCIe SSD 来说，插到一块老掉牙的主板上（MPS只有128 Byte），你的Payload Size再大，也是没有用的。

系统的 **MPS 值**设置是在**上电以后**的**设备枚举配置阶段**完成的，以主板上的 PCIe RC 和 PCIe SSD 为例，它们都在 `Device Capability Register` 里声明自己**能支持的各种 MPS**, **OS** 的 **PCIe 驱动**侦测到他们各自的能力值，然后**挑低的**那个设置到**两者**的 `Device Control Register` 中。

**PCIe SSD** 自身的 `MPS capability` 则是在其 **PCIe core 初始化阶段**设置的。

# Maximum Read Request Size

在配置阶段，OS 的 **PCIe 驱动**也会配置另外一个参数 Maximum Read Request Size，用于控制一个 Memory Read 的最大 Size，最大 4KB（以128 Byte为单位）。

Read Request Size是可以大于MPS的，比如给一个MPS=128Byte的PCIe SSD发一个512 Byte的Read Request, PCIe SSD可以通过返回4个128 Byte的Cpld，或者8个64 Byte的Cpld来完成这个Request的响应。OS层面可以通过控制PCIe SSD的Maximum Read Request Size参数，平衡多个PCIe SSD之间的吞吐量，避免系统带宽（总共40个Lane）被某些SSD霸占。

同时，Read Request Size也对PCIe SSD的Performance有影响，这个Size太小，意味着同样的Data，需要发送更多的Request去获取，而Read Request的TLP是不带任何Data Payload的。

举例来说，要传64KB的数据，如果Read Request=128 Byte，则需要512个Read TLP, 512个TLP的开销可是不小的。

为了提高特别是大Block Size Data的传输效率，可以尽量把Read Request Size设得大一点，用更少的次数传递更多的数据。

# 示例

```
$ lspci -t -v
 \-[0000:00]-+-11.0-[04]----00.0  Sandisk Corp WD Black SN850

$ sudo lspci -vvv -s 00:11.0
00:11.0 PCI bridge: Intel Corporation Device 1bb1 (rev 11) (prog-if 00 [Normal decode])
        ...
        Capabilities: [40] Express (v2) Root Port (Slot+), MSI 00   // 是个 root port
                DevCap: MaxPayload 256 bytes, PhantFunc 0
                        ExtTag+ RBE+
                DevCtl: CorrErr+ NonFatalErr+ FatalErr+ UnsupReq-
                        RlxdOrd- ExtTag+ PhantFunc- AuxPwr- NoSnoop-
                        MaxPayload 256 bytes, MaxReadReq 512 bytes

$ sudo lspci -vvv -s 04:00.0
04:00.0 Non-Volatile memory controller: Sandisk Corp WD Black SN850 (rev 01) (prog-if 02 [NVM Express])
        ...
        Capabilities: [c0] Express (v2) Endpoint, MSI 00            // 是个 endpoint
                DevCap: MaxPayload 512 bytes, PhantFunc 0, Latency L0s <1us, L1 unlimited
                        ExtTag- AttnBtn- AttnInd- PwrInd- RBE+ FLReset+ SlotPowerLimit 0.000W
                DevCtl: CorrErr+ NonFatalErr+ FatalErr+ UnsupReq-
                        RlxdOrd+ ExtTag- PhantFunc- AuxPwr- NoSnoop+ FLReset-
                        MaxPayload 256 bytes, MaxReadReq 512 bytes
```

注意看其中的 DevCap 和 DevCtl 数值



