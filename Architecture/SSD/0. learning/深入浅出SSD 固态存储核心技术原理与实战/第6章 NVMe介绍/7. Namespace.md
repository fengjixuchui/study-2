
什么是Namespace（以下简称NS）？

一个NVMe SSD主要由SSD控制器、闪存空间和PCIe接口组成。如果把闪存空间划分成若干个独立的逻辑空间，每个空间逻辑块地址（LBA）范围是0到N-1（N是逻辑空间大小），这样划分出来的每一个逻辑空间我们就叫作NS。对SATA SSD来说，一个闪存空间只对应着一个逻辑空间，与之不同的是，NVMe SSD可以是一个闪存空间对应多个逻辑空间。

每个NS都有一个名称与ID，如同每个人都有名字和身份证号码，ID是独一无二的，系统就是通过NS的ID来区分不同的NS。

如图6-50所示，整个闪存空间划分成两个NS，名字分别是NS A和NS B，对应的NS ID分别是1和2。如果NS A大小是M（以逻辑块大小为单位）, NS B大小是N，则它们的逻辑地址空间分别是0到M-1和0到N-1。主机读写SSD，都是要在命令中指定读写的是哪个NS中的逻辑块。原因很简单，如果不指定NS，对同一个LBA来说，假设就是LBA 0, SSD根本就不知道去读或者写哪里，因为有两个逻辑空间，每个逻辑空间都有LBA 0。



一个NVMe命令一共64字节，其中 `Byte[7:4]` 指定了要访问的 NS，如表所示。

NVMe 命令中 NS 域:



对每个NS来说，都有一个4KB大小的数据结构来描述它。该数据结构描述了该NS的大小，整个空间已经写了多少，每个LBA的大小，端到端数据保护相关设置，以及该NS是属于某个控制器还是几个控制器可以共享等。

NS由主机创建和管理，每个创建好的NS，从主机操作系统角度看来，就是一个独立的磁盘，用户可在每个NS做分区等操作。

下例中，整个闪存空间划分成两个 NS, NS A 和 NS B，操作系统看到两个完全独立的磁盘，如图所示。

NVMe子系统中有两个NS:



每个NS是独立的，逻辑块大小可以不同，端到端数据保护配置也可以不同：你可以让一个NS使用保镖，另一个NS不使用保镖，再一个NS半程使用保镖（见6.6节）。

其实，NS更多是应用在企业级，可以根据客户不同需求创建不同特征的NS，也就是在一个SSD上创建出若干个不同功能特征的磁盘（NS）供不同客户使用。

NS的另外一个重要使用场合是：SR-IOV。

什么是SR-IOV？英文全称为Single Root-IO Virtualization,SR-IOV技术允许在虚拟机之间高效共享PCIe设备，并且它是在硬件中实现的，可以获得能够与本机性能媲美的IO性能。单个IO资源（单个SSD）可由许多虚拟机共享。共享的设备将提供专用的资源，并且还使用共享的通用资源。这样，每个虚拟机都可访问唯一的资源。

如图所示，该SSD作为PCIe的一个Endpoint，实现了一个物理功能（Physical Function, PF），有4个虚拟功能（Virtual Function, VF）关联该PF。每个VF，都有自己独享的NS，还有公共的NS（NS E）。此功能使得虚拟功能可以共享物理设备，并在没有CPU和虚拟机管理程序软件开销的情况下执行IO。关于SR-IOV的更多知识，这里就不展开了，我们只需知道NVMe中的NS有用武之地就可以。

SR-IOV:



对一个NVMe子系统来说，除了包含若干个NS，还可以有若干个SSD控制器。注意，这里不是说一个SSD控制器有多个CPU，而是说一个SSD有几个实现了NVMe功能的控制器。

如图所示，一个NVMe子系统包含了两个控制器，分别实现不同功能（也可以是相同功能）。整个闪存空间分成3个NS，其中NS A由控制器0（左边）独享，NS C由控制器1（右边）独享，而NS B是两者共享。独享的意思是说只有与之关联的控制器才能访问该NS，别的控制器是不能对其进行访问的，图6-53中控制器0是不能对NS C进行读写操作的，同样，控制器1也不能访问NS A；共享的意思是说，该NS（这里是NS B）是可以被两个控制器共同访问的。对共享NS，由于几个控制器都可以对它进行访问，所以要求每个控制器对该NS的访问都是原子操作，从而避免同步问题。

NVMe子系统中有两个控制器:



事实上，一个NVMe子系统，除了可以有若干个NS，除了可以有若干个控制器，还可以有若干个PCIe接口。

与前面的架构不一样，下图的架构是每一个控制器都有自己的PCIe接口，而不是两者共享一个。Dual Port，双端口，在SATA SSD上没有见过吧。这两个接口往上有可能连着同一个主机，也可能连着不同的主机。现在能提供Dual PCIe Port的SSD接口只有SFF-8639（关于这个接口，可参看www.ssdfans.com站内文章《SFF-8639接口来袭》），也叫U.2，它支持标准的NVMe协议和Dual-Port。

双控制器和双端口NVMe子系统:



下图是两个PCIe接口连着一个主机的情况.

双端口子系统连接主机:



为什么要这么玩？

我认为，一方面，主机访问SSD，可以双管齐下，性能可能更好点。不过对访问NS B来说，同一时刻只能被一个控制器访问，双管齐下又如何。考虑到还可以同时操作NS A和NS C，性能或多或少会有所提升。

我觉得，更重要的是，这种双接口冗余设计可以提升系统可靠性。假设PCIe A接口出现问题，这个时候主机可以通过PCIe B无缝衔接，继续对NS B进行访问。当然了，NS A是无法访问了。

如果主机突然死机怎么办？在一些很苛刻的场景下是不允许主机宕机的。但是，是电脑总有死机的时候，怎么办？最直接有效的办法还是采用冗余容错策略：SSD有两个控制器，有两个PCIe接口，那么我主机也弄个双主机，一个主机挂了，由另一个主机接管任务，继续执行，如图6-56所示。

