
主机往SQ中写入命令，SSD往CQ中写入命令完成结果。SQ与CQ的关系，可以是一对一的关系，也可以是多对一的关系，但不管怎样，它们是成对的：有因就有果，有SQ就必然有CQ。

有两种SQ和CQ，一种是Admin，另外一种是IO，前者放Admin命令，用以主机管理控制SSD，后者放置IO命令，用以主机与SSD之间传输数据。Admin SQ/CQ和IO SQ/CQ各司其职，你不能把Admin命令放到IO SQ中，同样，你也不能把IO命令放到Admin SQ里面。IO SQ/CQ不是一生下来就有的，它们是通过Admin命令创建的。

正如图所示，系统中只有1对Admin SQ/CQ，它们是一一对应的关系；IO SQ/CQ却可以有很多，多达65535对（64K减去1对Admin SQ/CQ）。

SQ 和 CQ:



需要指出的是，对NVMe over Fabrics, SQ和CQ的关系只能是一对一；IO SQ/CQ也不是通过Admin命令创建的。

主机端每个CPU核（Core）可以有一个或者多个SQ，但只有一个CQ。给每个CPU核分配一对SQ/CQ好理解，为什么一个CPU核中还要多个SQ呢？一是性能需求，一个CPU核中有多线程，可以做到一个线程独享一个SQ；二是QoS需求，什么是QoS?Quality of Service，服务质量。脑补一个场景，蛋蛋一边看小电影，同时在后台用迅雷下载小电影，由于电脑配置差，看个小电影都卡。蛋蛋不要卡顿！怎么办？NVMe建议，你设置两个SQ，一个赋予高优先级，一个低优先级，把看小电影所需的命令放到高优先级的SQ，迅雷下载所需的命令放到低优先级的SQ，这样，你的电脑就能把有限的资源优先满足你看小电影了。至于迅雷卡不卡，下载慢不慢，这个时候已经不重要了。能让蛋蛋舒舒服服地看完一部小电影，就是好的QoS。实际系统中用多少个SQ，取决于系统配置和性能需求，可灵活设置I/O SQ个数。

关于系统中IO SQ的个数，NVMe白皮书给出如下建议（见下表）。

NVMe白皮书对NVMe的配置建议:



作为队列，每个SQ和CQ都有一定的深度：对Admin SQ/CQ来说，其深度可以是2～4096（4K）；对IO SQ/CQ，深度可以是2～65536（64K）。队列深度也是可以配置的。

SQ/CQ的个数可以配置，每个SQ/CQ的深度也可以配置，因此NVMe的性能是可以通过配置队列个数和队列深度来灵活调节的。

> 百变星君NVMe：想胖就胖，想瘦就瘦；想高就高，想矮就矮。

我们已经知道，AHCI只有一个命令队列，且队列深度是固定的32，和NVMe相比，无论是在命令队列广度还是深度上，都是无法望其项背的；NVMe命令队列的百般变化，更是AHCI无法做到的。说到百般变化，我突然又想到一件残忍的事情：PCIe也是可以的。一个PCIe接口，可以有1、2、4、8、12、16、32条lane！SATA都要哭了：单挑都挑不过你，你还来群殴我，太欺负人了。

每个SQ放入的是命令条目，无论是Admin还是IO命令，每个命令条目大小都是64字节；每个CQ放入的是命令完成状态信息条目，每个条目大小是16字节。

在继续谈大宝（DB）之前，先对SQ和CQ做个小结：

❏ SQ用以主机发命令，CQ用以SSD回命令完成状态；

❏ SQ/CQ可以在主机的内存中，也可以在SSD中，但一般在主机内存中（本书中除非特殊说明，不然都是基于SQ/CQ在主机内存中作介绍）；

❏ 两种类型的SQ/CQ:Admin和IO，前者发送Admin命令，后者发送IO命令；

❏ 系统中只能有一对Admin SQ/CQ，但可以有很多对IO SQ/CQ；

❏ IO SQ与CQ可以是一对一的关系，也可以是多对一的关系；

❏ IO SQ是可以赋予不同优先级的；

❏ IO SQ/CQ深度可达64K, Admin SQ/CQ深度可达4K；

❏ IO SQ/CQ的广度和深度都可以灵活配置；

❏ 每条命令大小是64B，每条命令完成状态是16B。

SQ/CQ中的“Q”指Queue，队列的意思（见图6-12），无论SQ还是CQ，都是队列，并且是环形队列。队列有几个要素，除了队列深度、队列内容，还有队列的头部（Head）和尾部（Tail）。

队列（Queue）的概念:



队伍头部的那个正在被服务或者等待被服务，一旦完成，就离开队伍。可见队列的头尾很重要，头决定谁会被马上服务，尾巴决定了新来的人站的位置。DB就是用来记录了一个SQ或者CQ的头和尾。每个SQ或者CQ，都有两个对应的DB:Head DB和Tail DB。DB是在SSD端的寄存器，记录SQ和CQ的头和尾巴的位置。

如图6-13所示是一个队列生产者/消费者（Producer/Consumer）模型。生产者往队列的尾部写入东西，消费者从队列的头部取出东西。对一个SQ来说，它的生产者是主机，因为它向SQ的尾部写入命令，消费者是SSD，因为它从SQ的头部取出指令执行；对一个CQ来说，刚好相反，生产者是SSD，因为它向CQ的尾部写入命令完成信息，消费者则是主机，它从CQ的头部取出命令完成信息。

