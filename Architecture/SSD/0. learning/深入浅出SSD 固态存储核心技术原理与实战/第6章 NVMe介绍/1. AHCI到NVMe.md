
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. SATA和AHCI](#1-sata和ahci)
- [2. PCIe和NVMe](#2-pcie和nvme)
- [3. NVMe优势](#3-nvme优势)
  - [3.1. 低时延(Latency)](#31-低时延latency)
  - [3.2. 高性能(Throughput&IOPS)](#32-高性能throughputiops)
  - [3.3. 低功耗](#33-低功耗)
- [4. next](#4-next)

<!-- /code_chunk_output -->

# 1. SATA和AHCI

HDD 和早期的 SSD 绝大多数都是使用 **SATA 接口**, 跑的是 **AHCI**(Advanced Host Controller Interface)**协议**, 它是由 Intel 联合多家公司研发的系统接口标准. AHCI 支持 NCQ(Native Command Queuing)功能和热插拔技术. NCQ **最大深度**为 **32**, 即**主机**最多可以发 32 条**命令**给 HDD 或者 SSD 执行, 跟之前硬盘只能逐条命令执行相比, 硬盘性能大幅提升.

在 HDD 时代或者 SSD 早期, **AHCI 协议 + SATA 接口**足够满足系统性能需求, 因为整个系统的**性能瓶颈**在**硬盘端**(低速, 高延时), 而不是在协议和接口端. 然而, 随着SSD技术的飞速发展, SSD盘的性能飙升, 底层闪存带宽越来越宽, 介质访问延时越来越低, 系统性能瓶颈已经由下转移到上面的接口和协议处了. AHCI和SATA已经不能满足高性能和低延时SSD的需求, 因此SSD迫切需要自己更快、更高效的协议和接口.

# 2. PCIe和NVMe

2009年下半年, 在带头大哥Intel的领导下, 美光、戴尔、三星、Marvell等巨头, 一起制定了专门为SSD服务的NVMe协议, 旨在将SSD从老旧的SATA和AHCI中解放出来.

何为NVMe? NVMe即 `Non-Volatile Memory Express`, 是**非易失性存储器标准**, 是跑在 PCIe 接口上的**协议标准**. NVMe 的**设计之初**就有充分利用了 **PCIe** SSD 的**低延时**以及**并行性**, 还有当代处理器、平台与应用的并行性. 相比现在的 AHCI 标准, NVMe 标准可以带来多方面的性能提升. NVMe 为 SSD 而生, 但不局限于以闪存为媒介的 SSD, 它同样可以应用在高性能和低延时的 **3D XPoint** 这类**新型的介质**上.

首款支持NVMe标准的产品是三星XS1715, 于2013年7月发布. 随后陆续有企业级的 NVMe 标准 SSD 推出. 2015 年 Intel 750 发布, 标志着 NVMe 标准的产品开始进入消费级市场. 如今市面上已经出现很多 NVMe SSD 产品, 包括企业级和消费级, 如果说前几年 NVMe SSD 是阳春白雪, 现如今已是下里巴人, NVMe SSD 已慢慢进入寻常百姓家.

>需要指出的是, 在移动设备上, NVMe 也占有一席之地. 苹果自 iPhone 6s 开始, 其存储设备上跑的就是 NVMe 协议标准. 未来移动存储的方向, 笔者认为不是 UFS, 当然更不会是 eMMC, 而是 NVMe, 拭目以待吧.

# 3. NVMe优势

那么, NVMe究竟有什么好? 跟AHCI相比, 它有哪些优势?

NVMe 和 AHCI 相比, 它的优势主要体现在以下几点:

## 3.1. 低时延(Latency)

造成硬盘存储时延的三大因素:

* **存储介质**层面, 闪存(Flash)比传统机械硬盘**速度快**太多了.

* **控制器**方面, 从 **SATA** SSD 发展成 **PCIe** SSD, **原生 PCIe 主控与 CPU 直接相连**(其实是 RC), 而不像传统方式, 要通过**南桥控制器中转**再连接 CPU, 因此基于 PCIe 的 SSD 时延更低.



* **软件接口**方面, NVMe 缩短了 **CPU** 到 **SSD** 的**指令路径**, 比如 NVMe **减少了对寄存器的访问次数**; 使用了 `MSI-X` **中断**管理; **并行&多线程优化** —— NVMe 减少了各个 CPU 核之间的锁同步操作等.

所以基于 **PCIe+NVMe** 的 SSD 具有非常低的延时, 如图6-1所示.

时延对比:

![2023-02-04-23-18-27.png](./images/2023-02-04-23-18-27.png)

## 3.2. 高性能(Throughput&IOPS)

理论上, `IOPS = 队列深度/IO延迟`, 故 IOPS 的性能与队列深度有较大的关系(但 IOPS 并不与队列深度成正比, 因为实际应用中, 随着**队列深度**的**增加**, **IO 延迟**也会**提高**).

市面上性能不错的 **SATA 接口 SSD**, 在**队列深度**上都可以达到 **32**, 然而这也是 AHCI 所能做到的极限. 但目前高端的企业级 **PCIe SSD**, 其**队列深度**可能要达到 **128**, 甚至是 **256** 才能够发挥出最高的 IOPS 性能. 而在 **NVMe** 标准下, 最大的**队列深度**可达 **64K**. 此外, NVMe 的**队列数量**也从 AHCI 的 **1**, 提高到了 **64K**.

> 队列深度: 队列上的命令数目?

**PCIe 接口**本身在**性能**上碾压 **SATA**, 再加上 **NVMe** 具有比 **AHCI** 更深、更宽的**命令队列**, NVMe SSD 在性能上秒杀 SATA SSD 是水到渠成的事情. 下图是 NVMe SSD、SAS SSD 和 SATA SSD 的性能对比图.

NVMe, SAS 和 SATA SSD 性能对比图:

![2023-02-04-23-33-56.png](./images/2023-02-04-23-33-56.png)

## 3.3. 低功耗

NVMe 加入了**自动功耗状态切换**和**动态能耗管理**功能, 具体在本书的第8章会介绍, 这里不再赘述.

# 4. next

> 下面大部分章节来源于www.ssdfans.com的《蛋蛋读NVMe》系列. 另外, 最新NVMe协议标准是NVMe1.3, 但本章是基于NVMe1.2写的, 请读者知晓.
