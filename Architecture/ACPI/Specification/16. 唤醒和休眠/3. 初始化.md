
本节介绍 ACPI 平台的**初始化顺序**。从 `S2`、`S3` 或 `S4` **休眠状态**（由 ACPI 休眠状态定义）**唤醒**或在 **reset** 后，CPU 将从其 boot vector 开始执行。此时，初始化软件有很多选项，具体取决于硬件平台支持的内容。本节简要介绍应针对这些不同选项执行的操作。下图说明了启动软件的流程。

> The processor will start executing at its power-on reset vector when waking from an S2, S3, or S4 sleeping state, during a power-on sequence, or as a result of a hard or soft reset

当 1. 从 S2、S3 或 S4 休眠状态唤醒, 或者 2. 在上电串行顺序期间(power-on sequence) 或者 3. 作为一个 hard 或 soft reset 的结果, 处理器将在其开机复位向量(power-on reset vector)处开始执行.

作为 1. **上电串行顺序**(power-on sequence), 或者 2. **一个 hard 或者 soft reset**, 或者 3. 从 **S4** 休眠状态唤醒 的结果, 处理器从**开机复位向量**(power-on reset vector)开始执行时, **平台固件**执行**完整的硬件初始化**; 将**系统**置于**引导配置**中。然后，固件将控制权传递给**操作系统引导加载进程**(boot loader)。

作为从 S2 或 S3 睡眠状态唤醒 的结果, 处理器从**开机复位向量**(power-on reset vector)开始执行时, 平台固件**仅执行**必要的硬件初始化, 从而恢复系统到要么是**初始操作系统启动之前**(initial operating system boot)**平台所处的状态**, 要么是**睡眠前配置的状态**(pre-sleep configuration state). 在多处理器系统中，**非引导处理器**应被置于与**初始操作系统启动之前**(initial operating system boot)相同的状态。然后，平台固件通过跳转到 `Firmware_Waking_Vector` 或 FACS 中的 `X_Firmware_Waking_Vector`。在 S2 或 S3 睡眠状态期间，操作系统内存内容的内容**不得更改**。

首先，**平台运行时固件**通过检查在休眠会话之间保留的 `SLP_TYP` 寄存器值来确定这是从 S2 还是 S3 唤醒。如果这是 S2 或 S3 唤醒，则**平台运行时固件**会在跳转到 waking vector **之前**还原系统的**最小上下文**。这包括：

* CPU 配置。平台运行时固件还原每个 CPU 的睡眠前配置或初始启动配置（MSR、MTRR、固件更新、SMBase 等）。必须禁用中断（对于 IA-32 处理器，由 CLI 指令禁用）。

* 内存控制器配置. 配置会在休眠状态期间丢失，平台运行时固件将内存控制器初始化为其睡眠前配置或初始启动配置。

* 缓存配置. 如果配置在休眠状态期间丢失，平台运行时固件会将缓存控制器初始化为其睡眠前配置或初始引导配置。

* 功能性设备配置. 平台运行时固件不需要配置/恢复功能设备的上下文，例如网络接口（即使它物理包含在芯片组中）或中断控制器。OSPM 负责恢复这些设备的所有上下文。硬件和平台运行时固件的唯一要求是确保在 control 被 pass 给 OS 时, 中断不会被设备 assert.

* ACPI 寄存器. 在 non-HW-reduced 的 ACPI 平台上, SCI_EN 必须被置位，并且所有的事件 状态/启用位（PM1x_STS、PM1x_EN、GPEx_STS 和 GPEx_EN）不得通过平台运行时固件进行更改。

![2023-06-13-14-46-54.png](./images/2023-06-13-14-46-54.png)

> 注意: 平台运行时固件可以将 CPU、内存控制器和高速缓存控制器重新配置为睡眠前配置或者初始启动配置。OSPM 必须同时满足这两种配置。

从 S4BIOS 休眠状态唤醒时，平台启动固件初始化最少数量的设备，例如 CPU、内存、缓存、芯片组和启动设备。初始化这些设备后，平台启动固件从非易失性存储器（如硬盘）恢复内存上下文，并跳转到 waking vector。

如前所述，从 S4 状态唤醒与冷启动(cold boot)相同：平台启动固件运行开机自检(POST)，然后初始化内存以包含 ACPI 系统描述符表。完成此操作后，它可以调用OSPM 加载进程，并将控制权传递给 OSPM。

从 S4（S4OS 或 S4BIOS）唤醒时，平台启动固件可以选择在将控制权传递给 OSPM 之前设置 `SCI_EN` 位。在这种情况下，必须禁用中断（对于 IA-32 处理器，禁用 CLI 指令）直到将控制权传递给 OSPM，并且 chipset 芯片组必须被配置为 ACPI 模式。

# 将系统置于 ACPI 模式

当平台从 code boot(机械关闭或从 S4 或 S5 状态)初始化时，硬件平台可能会在 legacy configuration 中配置，如果不是在 HW-reduced ACPI 平台。从这些状态开始，平台启动固件软件会初始化计算机，就像初始化一个 legacy 操作系统一样。当控制权传递给操作系统时，OSPM 将检查 SCI_EN 位，如果**未设置**，则通过首先查找 ACPI 表，然后生成对 SMI_CMD 端口的 `ACPI_ENABLE` 值的写入来**启用 ACPI 模式**（如 FADT 中所述）。硬件平台将设置 `SCI_EN` 位，以向 OSPM 指示硬件平台现在已针对 ACPI 配置。

注意: 

当平台从 S1、S2 或 S3 状态以及 hw-reduced 的 ACPI 平台上的 S4 和 S5 唤醒时，OSPM **假定**硬件已处于 **ACPI 模式**，并且**不会**向 `SMI_CMD` 端口发出 `ACPI_ENABLE` 命令

# 内存的平台启动固件初始化

在**开机复位**(power-on reset)、**退出 S4 休眠状态**或**退出 S5 软关闭状态**期间，平台启动固件需要**初始化内存**。

本节说明平台启动固件应**如何配置内存**以供许多功能使用，包括:

* ACPI 表

* 平台固件内存想要在 S4 休眠会话中保存且应缓存。

* 平台固件内存不需要保存且应缓存


