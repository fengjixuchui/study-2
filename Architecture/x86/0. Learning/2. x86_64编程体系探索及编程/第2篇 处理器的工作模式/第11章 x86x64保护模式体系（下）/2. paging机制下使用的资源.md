
<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 寄存器](#1-寄存器)
- [2. 能力检查](#2-能力检查)
  - [2.1. CPUID.01H leaf功能](#21-cpuid01h-leaf功能)
  - [2.2. CPUID.07H leaf功能](#22-cpuid07h-leaf功能)
  - [2.3. CPUID.80000001H leaf功能](#23-cpuid80000001h-leaf功能)
- [3. 寄存器的控制位](#3-寄存器的控制位)
- [4. 页转换表资源](#4-页转换表资源)
  - [4.1. 32位paging模式中](#41-32位paging模式中)
  - [4.2. PAE paging模式中](#42-pae-paging模式中)
  - [4.3. IA-32e paging模式中](#43-ia-32e-paging模式中)

<!-- /code_chunk_output -->

# 1. 寄存器

下面的寄存器需要被使用.

① CR0、CR2、CR3和CR4.

② IA32\_EFER.

**CR0** 和 **CR4** 用来**开启和控制 paging 机制及页转换表结构**, **CR2 是保存发生 #PF 异常的线性地址**, **CR3 是整个页转换表结构的基地址**.

**IA32_EFER** 用于开启 `IA\-32e`模式(`long-mode`).

# 2. 能力检查

在 **paging 机制**里某些功能需要**先查询处理器是否支持**, 在支持的情况下才可以 **enable** 功能.

## 2.1. CPUID.01H leaf功能

在 **01H 叶**里**返回的 ECX 和 EDX 寄存器**包括了**大多数 paging 机制**的 **support 位**.

1. `ECX[17].PCID` 位: 指示处理器**是否支持 PCID 功能**, 支持的话可以**开启 CR4.PCIDE 控制位**.

2. `EDX[3].PSE` 位: 指示**是否支持 4M 页面**, 支持的话可以对 **CR4.PSE 控制位置位**. 在 **32 位 paging 模式**下通过**PDE.PS=1**来使用**4M页面**. 这个support位**与PSE\-36位是不同的意义**, 但 `PSE-36` 功能需要配合4M页面使用.

3. `EDX[17].PSE-36` 位: 如果支持: 指示在**32位paging模式**下, PDE能提供**最高40位的物理地址**. 那么 `PDE[16: 13]` 是 36 位物理地址的高 4 位, 或者 `PDE[20: 13]` 是40位物理地址的高8位. 如果**不支持则这些位为保留位**.

4. `EDX[6].PAE`位: 指示是否支持**PAE(Physical Address Extensions)模式**, 是的话通过对CR4.PAE置位使用PAE paging模式, 并可以使用**36位、40位或52位的最高物理地址**, 依赖于**MAXPHYADDR值**.

5. `EDX[16].PAT`位: 指示是否支持**PAT(Page Attribute Table)功能**.

6. `EDX[13].PGE`位: 指示是否支持**PGE(Page Global Enable)功能**, 支持的话可以置`CR4.PGE=1`支持Global page功能.

## 2.2. CPUID.07H leaf功能

在07H叶的0H子叶里(EAX=07H, ECX=0H)返回以下内容.

1. `EBX[7].SMEP`位: 指示是否支持SMEP(Supervisor-Mode Execution Prevention)功能, 是的话可以对CR4.SMEP控制位进行置位.

2. `EBX[10].INVPCID`位: 指示是否支持 **INVPCID** 指令.

## 2.3. CPUID.80000001H leaf功能

在80000001H叶里主要是针对Intel64和AMD64机器, 即支持long-mode的机器.

1. `EDX[29].LM`位: 指示是否支持Intel64或long-mode.

2. `EDX[20].XD`位: 在AMD64中是NX位, 指示是否支持Execution Disable功能. 是的话可以在PAE模式和IA-32e页转换模式里使用XD位.

3. `EDX[26].1G-page`位: 指示处理器是否支持1G页面.

CPUID.80000008H leaf 功能这个叶功能将返回MAXPHYADDR值和最高virtual address值.

1. `EAX[7: 0]`: 返回MAXPHYADDR值.

2. `EAX[15: 8]`: 返回最高virtual address值.

# 3. 寄存器的控制位

CR0 和 CR4 有许多控制位被使用在 paging 机制上.

① `CR0.PG`: 在 CR0.PE=1 的基础上, 置 CR0.PG=1 开启 paging 机制.

② `CR0.WP`: 对 `CR0.WP` 置位可以启用 Write Protect 功能, 使 Supervisor 用户也无权对 `Read-only`(只读)页进行修改.

③ `CR0.CD`与`CR0.NW`: 将影响到各级页转换表结构里的PCD和PWT标志, 包括CR3.

④ `CR4.PSE`: 置 CR4.PSE=1 时, 配合 `PDE.PS` 标志位在 32 位 paging 模式里使用 4M 页面.

⑤ `CR4.PAE`: 置 CR4.PAE=1 时, 开启 PAE paging 模式. CR4.PAE 控制位将忽略 CR4.PSE 的作用.

⑥ `CR4.PGE`: 置 CR4.PGE=1 时, 配合 PDE.G 和 PTE.G 标志位启用 Global page 功能, 当更新 CR3 时, TLB 里 Global page 不被刷新.

⑦ `CR4.SMEP`: 置 `CR4.SMEP=1` 时, 启用 SMEP 功能, 防止 Supervisor 用户执行用户代码.

⑧ `CR4.PCIDE`: 置 CR4.PCIDE=1 时, 启用 process-context identifier 功能.

⑨ `IA32_EFER.LME`: 置 `IA32_EFER.LME=1` 时, 开启 `long-mode`, 但需要开启 paging 机制后才被激活.

⑩ `IA32_EFER.LMA`: 置 `CR4.PAE=1`, 且 CR4.PG=1 时, 激活 long-mode.

⑪ `IA32_EFER.NXE`: 置 `IA32_EFER.NXE=1` 时, 在 PAE paging 模式和 `IA-32e paging` 模式里启用 Execution Disable 功能.

# 4. 页转换表资源

处理器 paging 机制里使用的**各级页转换表**, 最终是为了查找线性地址映射到物理地址空间上相应的 page frame, 再由 page frame 基地址加上 page offset 值得出最终的物理地址.

![config](./images/8.png)

在三种paging模式里, 根据不同的页面尺寸使用**不同的页转换表结构**.

## 4.1. 32位paging模式中

**线性地址是32位宽**, 采用一级或两级页转换表, 每个表项大小是4字节宽, CR3使用32位.

① 4K页面下: 使用 PDT(page directory table, 页目录表)和PT(page table, 页表)两级表格.

**4KB页面线性地址构成: 10(PDT索引, 1024个项) + 10(PT索引, 1024个项) + 12(Page offset, 4KB页**)

**一个PDT和一个PT大小都是4KB**.

② 4M页面下: 使用PDT(page directory table)一级表格.

**4MB页面线性地址构成: 10(PDT索引, 1024个项) \+ 22(Page offset, 4MB页**)

**一个PDT大小是4KB**

## 4.2. PAE paging模式中

**线性地址32位宽**, 使用两级或三级页转换表, **每个表项8字节宽**, CR3还是32位, 但只使用了27位, 拼凑了32位PDPT物理地址.

在PAE paging模式里使用两级或三级页转换表.

① 4K页面下: 使用PDPT(page directory pointer table, 页目录指针表), PDT和PT.

**4KB页面线性地址构成: 2(PDPT索引, 4个项) \+ 9(PDT索引, 512个项) \+ 9(PT索引, 512个项) \+ 12(Page offset, 4KB页**)

PDPT大小可以是4x8=32字节, PDT和PT仍然是4KB大小, 512x8.

② 2M页面下: 使用PDPT和PDT.

**2MB页面线性地址构成: 2(PDPT索引, 4个项) \+ 9(PDT索引, 512个项) \+ 21(Page offset, 2MB页**)

PDPT大小可以是4x8=32字节, PDT是4KB

## 4.3. IA-32e paging模式中

线性地址48位宽, 使用两级到四级的页转换表, 每个表项都是8字节宽, CR3是64位宽, 针对是否支持PCIDE功能, CR3使用不一样.

① 4K页面下: 使用PML4T(page map level-4 table, 四层映射表), PDPT, PDT和PT.

**4KB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 9(PDT索引, 512个项) \+ 9(PT索引, 512个项) \+ 12(Page offset, 4KB页**)

每个table(PML4T, PDPT, PDT, PT)大小都是4KB = 512x8

② 2M页面下: 使用PML4T, PDPT和PDT.

**2MB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 9(PDT索引, 512个项) \+ 21(Page offset, 2MB页**)

每个table(PML4T, PDPT, PDT)大小都是4KB = 512x8

③ 1G页面下: 使用PML4T和PDPT.

**1GB页面线性地址构成: 9(PML4T索引, 512个项) \+ 9(PDPT索引, 512个项) \+ 30(Page offset, 1GB页**)

每个table(PML4T, PDPT, PDT)大小都是4KB = 512x8

每个table里的entry(表项)分别被称为PTE(Page Table Entry)、PDE(Page Directory Table Entry)、PDPE(Page Directory Pointer Table Entry)和PML4E(Page\-Map Leve\-4 Table Entry).

