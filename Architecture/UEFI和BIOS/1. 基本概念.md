<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [1. 固件接口标准](#1-固件接口标准)
  - [1.1 BIOS](#11-bios)
  - [1.2 EFI/UEFI](#12-efiuefi)
- [2. 启动方式](#2-启动方式)
  - [2.1 Legacy mode](#21-legacy-mode)
  - [2.2 UEFI mode](#22-uefi-mode)
    - [2.3 CSM mode](#23-csm-mode)
  - [3. 分区表](#3-分区表)
    - [3.1 MBR分区表](#31-mbr分区表)
    - [3.2 EBR分区表](#32-ebr分区表)
    - [3.3 GPT分区表](#33-gpt分区表)
  - [4. 分区](#4-分区)
    - [4.1 ESP(EFI系统分区)](#41-espefi系统分区)
    - [4.2 Windows恢复分区](#42-windows恢复分区)
  - [5. Bootloader](#5-bootloader)
    - [5.1 Grub](#51-grub)
    - [5.2 Windows Boot Manager](#52-windows-boot-manager)
    - [5.3 NTLDR](#53-ntldr)
- [小结](#小结)

<!-- /code_chunk_output -->

# 1. 固件接口标准

## 1.1 BIOS

IBM 推出的业界标准的**固件接口**, 存储于主板的 `ROM`/`EEPROM`/`flash` 中, 提供的功能包括:

- 开机自检
- **加载引导程序**(**MBR**中的, 通常是 **bootloader** 的**第一级**)
- 向 OS 提供抽象的硬件接口

PS: **CMOS** 是 PC 上的另一个重要的**存储器**, 用于保存 BIOS 的设置结果, CMOS 是 RAM.

## 1.2 EFI/UEFI

`Unified Extensible Firmware Interface`,  **统一可扩展固件接口**, 架设在**系统固件之上**的**软件接口**, 用于**替代 BIOS 接口**, EFI是UEFI的前称.

一般认为 UEFI 由以下几个部分组成:

- Pre-EFI 初始化模块
- EFI 驱动程序执行环境(DXE)
- EFI 驱动程序
- 兼容性支持模块(CSM)
- EFI 高层应用
- GUID 磁盘分区表(GPT)

通常

* **初始化模块**和 **DXE** 被集成在**一个 ROM** 中;

* **EFI 驱动程序**一般在设备的 **ROM** 中或者 **ESP** 中;

* **EFI 高层应用**一般在 **ESP** 中;

* **CSM** 用于给不具备 UEFI 引导能力的操作系统提供类似于**传统 BIOS** 的系统服务.

# 2. 启动方式

## 2.1 Legacy mode

即通过 `MBR/BIOS` 进行引导的传统模式, 流程如下:

1. BIOS 加电自检(Power On Self Test -- POST).

2. 读取**主引导记录**(MBR). BIOS 根据 **CMOS** 中的设置**依次检查启动设备**: 将相应启动设备的**第一个扇区**(也就是 **MBR 扇区**)读入内存.
    - 检查 MBR 的**结束标志位**是否等于 **55AAH**, 若不等于则转去尝试其他启动设备, 如果没有启动设备满足要求则显示"NO ROM BASIC"然后死机.
    - 当检测到有启动设备满足要求后, **BIOS** 将**控制权**交给相应**启动设备**的 **MBR**.
3. 根据 **MBR** 中的**引导代码**启动引导程序.

## 2.2 UEFI mode

UEFI启动**不依赖**于 **Boot Sector**(比如 **MBR**), 大致流程如下:

1. `Pre-EFI` 初始化模块运行, **自检**;
2. 加载**DXE**(EFI 驱动程序执行环境), 枚举并加载 **EFI驱动程序**(设备 **ROM** 或 **ESP** 中);
3. 找到 **ESP** 中的**引导程序**通过其引导操作系统.

### 2.3 CSM mode

UEFI 中的**兼容性支持模块**(Compatible Support Module)提供了引导 **UEFI 固件**的 PC 上的**传统磁盘**(`MBR` 格式)的方法.

## 3. 分区表

### 3.1 MBR分区表

指的是512字节的Master Boot Record(主引导记录)中的分区表由于大小限制其中只能存有最多四个分区的描述(亦即4个主分区).

### 3.2 EBR分区表

位于Extended Boot Record(扩展引导纪录)中的分区表该分区表所描述的分区即扩展分区. 每个EBR仅表示了一个扩展分区该扩展分区紧接在它的EBR后. EBR中的四个分区描述符中的第一个表示其描述的分你去第二个描述符则表示下一个扩展分区(如果是最后一个则为空)也就是说各个EBR串接成了一个EBR链表.

### 3.3 GPT分区表

GUID Partition Table是EFI标准的一部分用于替代MBR分区表相较起来有分区更大数量更多(没有4个主分区的限制)等优势GPT格式的硬盘结构如下可以看到首部MBR的位置有个保护MBR(用于防止不识别GPT的硬盘工具错误识别并破坏硬盘中的数据)这个MBR中只有一个类型为0xEE的分区. GPT结构如下:

![config](images/17.jpg)

## 4. 分区

分区可以是文件系统启动kernel imagebootloader裸程序或者参数等各种数据.

MBR Partition ID(分区类型): https://en.wikipedia.org/wiki/Partition_type

### 4.1 ESP(EFI系统分区)

EFI System PartitionFAT格式**在MBR的分区类型ID是0xEF**. 主要目录是EFI. EFI/boot/bootx64.efi是EFI默认的启动项. 安装的操作系统会建立相应的目录EFI/xxx并将自己的启动项复制为到EFI/boot/bootx64.efi作为缺省启动项.

UEFI官网上注册的EFI的子目录: http://www.uefi.org/registry

比如安装Windows的时候会在ESP分区中建立EFI/Microsoft子目录并将EFI/Microsoft/bootmgr.efi复制到EFI/boot/bootx64.efi.

安装Ubuntu的时候会在ESP分区中建立EFI/Ubuntu子目录并将EFI/ubuntu/grubx64.efi(grub bootloader)复制为EFI/boot/bootx64.efi. 因为Grub本身会扫描磁盘上的分区并找到windows启动程序(bootmgr.efi)因此先装windows后装ubuntu仍能通过grub让windows启动.

Linux也可以直接将编译出的Kernel及initrd(打开EFI Stub编译选项)作为efi文件复制到ESP中直接启动.

也可以在PC的系统设置中添加启动项.

维基百科的ESP条目:

### 4.2 Windows恢复分区

NTFS格式的分区即Windows Recovery EnvironmentWinPE+工具集

## 5. Bootloader

Bootloader即上文中提到的引导程序用于启动操作系统或者其它引导程序(比如Grub启动Windows Bootmgr)

### 5.1 Grub

GNU的开源引导程序可以用于引导Linux等操作系统或者用于链式引导其它引导程序(比如Windows Boot Manager)分为三个部分分别称为步骤1、1.5、2看名字就可以知道步骤1.5是可有可没有的这三个步骤对应的文件分别是:

- Boot.img: 步骤1对应的文件446个字节大小步骤1可以引导步骤1.5也可以引导步骤2. MBR分区格式的磁盘中放在MBR里(446也是为了符合MBR的启动代码区大小);  GPT分区格式的磁盘中放在Protective MBR中.
- Core.img: 步骤1.5对应的文件32256字节大小. MBR分区格式的磁盘中放在紧邻MBR的若干扇区中; GPT分区格式的磁盘中则放在34号扇区开始的位置(第一个分区所处的位置)而对应的GPT分区表中的第一个分区的entry被置空. 通常其中包含文件系统驱动以便load步骤2的文件.
- /boot/grub: 步骤2对应的文件目录放在系统分区或者单独的Boot分区中

![config](images/18.jpg)

### 5.2 Windows Boot Manager

是从Windows Vista开始引进的新一代开机管理程序用以取代NTLDR.

当电脑运行完开机自检后传统型BIOS会根据引导扇区查找开机硬盘中标记"引导"分区下的BOOTMGR文件; 若是UEFI则是Bootmgfw.efi文件和Bootmgr.efi文件接着管理程序会读取开机配置数据库(BCD, Boot Configuration Database)下的引导数据接着根据其中的数据加载与默认或用户所选择的操作系统.

### 5.3 NTLDR

是微软的Windows NT系列操作系统(包括Windows XP和Windows Server 2003)的引导程序. NTLDR可以从硬盘以及CD-ROM、U盘等移动存储器运行并引导Windows NT系统的启动. 如果要用NTLDR启动其他操作系统则需要将该操作系统所使用的启动扇区代码保存为一个文件NTLDR可以从这个文件加载其它引导程序.

NTLDR主要由两个文件组成这两个文件必须放在系统分区(大多数情况下都是C盘):

1. NTLDR引导程序本身
2. boot.ini引导程序的配置文件

# 小结

**分区表**是在磁盘(存储介质)上的, 用于**描述该磁盘的分区情况**, 有**GPT 和 MBR** 两种格式.

**BIOS和UEFI**是**固件接口标准**功能包括开机自检、启动流程(如何找到引导程序)、给操作系统和引导程序提供系统服务等.

**MBR是引导扇区**包括最多446个字节的引导程序(通常是引导程序的前部)和MBR分区表其中可以包括4个主分区.

启动方式是指如何主板上的固件在开机自检后如何找到引导程序有Legacy模式(BIOS + MBR)和UEFI模式(UEFI + GPT)


https://zhuanlan.zhihu.com/p/36976698


