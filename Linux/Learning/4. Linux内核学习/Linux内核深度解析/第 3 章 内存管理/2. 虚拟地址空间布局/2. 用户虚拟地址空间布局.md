
进程的用户虚拟地址空间的起始地址是0，长度是TASK_SIZE，由每种处理器架构定义自己的宏TASK_SIZE。ARM64架构定义的宏TASK_SIZE如下所示。

（1）32位用户空间程序：TASK_SIZE的值是TASK_SIZE_32，即0x100000000，等于4GB。

（2）64位用户空间程序：TASK_SIZE的值是TASK_SIZE_64，即2VA_BITS字节，VA_BITS是编译内核时选择的虚拟地址位数。

```cpp
// arch/arm64/include/asm/memory.h
#define VA_BITS          (CONFIG_ARM64_VA_BITS)
#define TASK_SIZE_64     (UL(1) << VA_BITS)
#ifdef CONFIG_COMPAT    /* 支持执行32位用户空间程序 */
#define TASK_SIZE_32     UL(0x100000000)
/* test_thread_flag(TIF_32BIT)判断用户空间程序是不是32位 */
#define TASK_SIZE       (test_thread_flag(TIF_32BIT) ? \
		TASK_SIZE_32 : TASK_SIZE_64)
#define TASK_SIZE_OF(tsk)  (test_tsk_thread_flag(tsk, TIF_32BIT) ? \
		TASK_SIZE_32 : TASK_SIZE_64)
#else
#define TASK_SIZE    TASK_SIZE_64
#endif /* CONFIG_COMPAT */
```

进程的用户虚拟地址空间包含以下区域。

（1）代码段、数据段和未初始化数据段。

（2）动态库的代码段、数据段和未初始化数据段。

（3）存放动态生成的数据的堆。

（4）存放局部变量和实现函数调用的栈。

（5）存放在栈底部的环境变量和参数字符串。

（6）把文件区间映射到虚拟地址空间的内存映射区域。

内核使用内存描述符 mm_struct 描述进程的用户虚拟地址空间，内存描述符的主要成员如表3.1所示。

内存描述符的主要成员:

![2022-04-14-16-04-28.png](./images/2022-04-14-16-04-28.png)

进程描述符（task_struct）中和内存描述符相关的成员如表3.2所示。

表3.2 进程描述符中和内存描述符相关的成员:

![2022-04-14-16-05-41.png](./images/2022-04-14-16-05-41.png)

如果进程不属于线程组，那么进程描述符和内存描述符的关系如图3.3所示，进程描述符的成员mm和active_mm都指向同一个内存描述符，内存描述符的成员mm_users是1、成员mm_count是1。

图3.3 进程的进程描述符和内存描述符的关系



如果两个进程属于同一个线程组，那么进程描述符和内存描述符的关系如图3.4所示，每个进程的进程描述符的成员mm和active_mm都指向同一个内存描述符，内存描述符的成员mm_users是2、成员mm_count是1。

图3.4 线程组的进程描述符和内存描述符的关系



内核线程的进程描述符和内存描述符的关系如图3.5所示，内核线程没有用户虚拟地址空间，当内核线程没有运行的时候，进程描述符的成员mm和active_mm都是空指针；当内核线程运行的时候，借用上一个进程的内存描述符，在被借用进程的用户虚拟地址空间的上方运行，进程描述符的成员active_mm指向借用的内存描述符，假设被借用的内存描述符所属的进程不属于线程组，那么内存描述符的成员mm_users不变，仍然是1，成员mm_count加1变成2。

图3.5 内核线程的进程描述符和内存描述符的关系



为了使缓冲区溢出攻击更加困难，内核支持为内存映射区域、栈和堆选择随机的起始地址。进程是否使用虚拟地址空间随机化的功能，由以下两个因素共同决定。

（1）进程描述符的成员personality（个性化）是否设置ADDR_NO_RANDOMIZE。

（2）全局变量randomize_va_space:0表示关闭虚拟地址空间随机化，1表示使内存映射区域和栈的起始地址随机化，2表示使内存映射区域、栈和堆的起始地址随机化。可以通过文件 “`/proc/sys/kernel/randomize_va_space`” 修改。