
ARM64处理器架构的内核地址空间布局如图3.8所示.

ARM64架构的内核地址空间布局:

![2022-04-14-16-20-48.png](./images/2022-04-14-16-20-48.png)

(1) **线性映射区域**的范围是`[PAGE_OFFSET, 2^64−1]`, 起始位置是 `PAGE_OFFSET =(0xFFFF FFFF FFFF FFFF << (VA_BITS-1))`, **长度**是**内核虚拟地址空间的一半**.

> `[a, b]` 是左闭右闭, `[a, b)` 是左闭右开.

称为线性映射区域的原因是虚拟地址和物理地址是线性关系:

`虚拟地址 = ((物理地址 − PHYS_OFFSET) + PAGE_OFFSET)`, 其中 `PHYS_OFFSET` 是内存的起始物理地址, ARM 中 PHYS_OFFSET 是0，所以`虚拟地址= 物理地址 + PAGE_OFFSET`.

(2) **vmemmap 区域**的范围是 `[VMEMMAP_START, PAGE_OFFSET)`, 长度是 `VMEMMAP_SIZE =(线性映射区域的长度 / 页长度 * page结构体的长度上限)`.

内核使用 `struct page` 描述一个物理页, 内存的**所有物理页**对应**一个 page 结构体数组**. 如果内存的**物理地址！！！空间不连续**, 存在很多空洞, 称为**稀疏内存**. vmemmap区域是**稀疏内存**的 **page 结构体数组**的虚拟地址空间.

(3) **PCI I/O 区域**的范围是 `[PCI_IO_START, PCI_IO_END)`, 长度是**16MB**, **结束地址**是`PCI_IO_END = (VMEMMAP_START − 2MB)`.

外围组件互联(Peripheral Component Interconnect, PCI) 是一种总线标准, PCI I/O区域是PCI设备的**I/O地址空间**.

(4) **固定映射区域**的范围是 `[FIXADDR_START, FIXADDR_TOP)`, 长度是 `FIXADDR_SIZE`, 结束地址是 `FIXADDR_TOP = (PCI_IO_START − 2MB)`.

固定地址是**编译时**的特殊虚拟地址, 编译的时候是**一个常量**, 在**内核初始化**的时候映射到物理地址, **dtb** 上电映射就在这个区域中.

(5) **vmalloc区域**的范围是 `[VMALLOC_START, VMALLOC_END)`, 起始地址是 `VMALLOC_START`, 等于**内核模块区域的结束地址**, 结束地址是 `VMALLOC_END = (PAGE_OFFSET − PUD_SIZE − VMEMMAP_SIZE − 64KB)`, 其中 **PUD_SIZE** 是**页上级目录表项**映射的地址空间的长度.

vmalloc 区域是函数 vmalloc 使用的虚拟地址空间, 内核使用 vmalloc 分配**虚拟地址连续**但**物理地址不连续**的内存.

**内核镜像**在 vmalloc 区域, 起始虚拟地址是 `(KIMAGE_VADDR + TEXT_OFFSET)`, 其中 `KIMAGE_VADDR` 是内核镜像的虚拟地址的**基准值**, 等于**内核模块区域的结束地址** `MODULES_END`; `TEXT_OFFSET` 是内存中的内核镜像相对内存起始位置的偏移.

(6) 内核模块区域的范围是 `[MODULES_VADDR,MODULES_END)`, 长度是128MB, 起始地址是MODULES_VADDR =(内核虚拟地址空间的起始地址 +KASAN影子区域的长度) .

内核模块区域是内核模块使用的虚拟地址空间.

(7) KASAN影子区域的起始地址是内核虚拟地址空间的起始地址, 长度是内核虚拟地址空间长度的1/8.

内核地址消毒剂(Kernel Address SANitizer, KASAN) 是一个动态的内存错误检查工具. 它为发现释放后使用和越界访问这两类缺陷提供了快速和综合的解决方案.