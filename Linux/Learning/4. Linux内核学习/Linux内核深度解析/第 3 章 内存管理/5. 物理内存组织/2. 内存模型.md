
# 内存模型

内存模型是从**处理器的角度**看到的**物理内存分布情况**, 内核管理不同内存模型的方式存在差异. 

随着内核从32位到64位发展, 物理内存管理也不断进行技术更新, 按照历史演进共有FLATMEM、DISCONTIGMEM以及SPRARSEMEM模型. 关于三个物理内存模型社区文档有总体说明介绍: [memory-model](https://www.kernel.org/doc/html/latest/vm/memory-model.html)

(1)**平坦内存**(Flat Memory): 内存的物理地址空间是**连续**的, **没有空洞**. 

(2)**不连续内存**(Discontiguous Memory): 内存的物理地址空间**存在空洞**, 这种模型可以高效地处理空洞. 

(3)**稀疏内存**(Sparse Memory): 内存的物理地址空间**存在空洞**. 如果要**支持内存热插拔**, 只能选择稀疏内存模型. 

什么情况会出现内存的物理地址空间存在空洞？系统包含**多块物理内存**, 两块内存的物理地址空间之间存在**空洞**. **一块内存**的物理地址空间也可能存在**空洞**, 可以查看处理器的参考手册获取分配给内存的物理地址空间. 

如果内存的物理地址空间是连续的, 不连续内存模型会产生额外的开销, 降低性能, 所以平坦内存模型是更好的选择. 

如果内存的物理地址空间存在空洞, 应该选择哪种内存模型？**平坦内存模型**会为**空洞**分配 **page 结构体**, 浪费内存；而**不连续内存模型**对空洞做了优化处理, 不会为空洞分配page结构体. 和平坦内存模型相比, 不连续内存模型是更好的选择. 

linux 物理内存模型是内核源码中为数不多的能够保存三个模型源码代码的模块, 在使用过程中用户可以根据需要配置内核选择相应的模型,目前SPRARSEMEM使用较多. 

# flat mem

在理解内存管理模型中, 需要理解一些基本内存概念会在讲解过程中进行穿插讲解. 

FLATMEM模型

flat中文意思就是水平、平坦的, 按照字面意思理解该模型即位平坦模型, 它是linux最早的模型管理, 一直在早期支撑了linux发展, 其他两种内存管理模型也是在该模型基础上进化, 所以要理解linux 内存管理, 必须要了解此模型, 包括很多概念比如 pfn, 页等都是在该模型概念基础上进行提出的. 

flat物理模型其实质就是将整块物理内存划分到一个数组中进行管理, 整个物理内存划分到一个数组 mem_map 数组中实现一个平滑管理. 

划分 mem_map 数组过程中, 基于空间和效率来讲, 内核整个物理内存划分成一页即 page 为单位进行管理, mem_map 数组单位为 struct page, 物理内存管理的最小颗粒度即为页, 如下图所示: 

![2022-04-15-12-51-42.png](./images/2022-04-15-12-51-42.png)




# SPARSE

在内核 FLAT 和DISCONTIGMEM管理模型中, 其实一直都存在两个问题

* 管理物理内存的**数据结构本身**占用**内存**较多, 不适用于较大内存情况
* 无法解决空洞问题, 不管是 FLAT 还是 SPARCE 模型都**无法解决一个节点内的内存空洞问题**, 必须是一段连续空间, 即 `mem_map` 数组就很大, 即使中间存在黑洞, mem_map数组必须也得申请, 比较浪费空间

基于上述两个主要问题linux 物理内存模型技术演进到SPARCE模型 本意是稀疏即不再是连续的, space 模式是从 `https://lwn.net/Articles/134804/` 开引入到内核中, 下面说明了该模型的几个优势: 

>
>Sparsemem abstracts the use of discontiguous mem_maps[].This kind of mem_map[] is needed by discontiguous memory machines (like in the old CONFIG_DISCONTIGMEM case) as well as memory hotplug systems.Sparsemem replaces DISCONTIGMEM when enabled, and it is hoped that it can eventually become a complete replacement. A significant advantage over DISCONTIGMEM is that it's completely separated from CONFIG_NUMA.  When producing this patch, it became apparent in that NUMA and DISCONTIG are often confused.
>
>Another advantage is that sparse doesn't require each NUMA node's ranges to be contiguous.  It can handle overlapping ranges between nodes with no problems, where DISCONTIGMEM currently throws away that memory.


# reference

物理内存模型之FLATMEM(1): https://zhikunhuo.blog.csdn.net/article/details/108549107