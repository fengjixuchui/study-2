
透明巨型页（Transparent Huge Page, THP）对进程是透明的，如果虚拟内存区域足够大，并且允许使用巨型页，那么内核在分配内存的时候首先选择分配巨型页，如果分配巨型页失败，回退分配普通页。

# 使用方法

透明巨型页的配置宏如下所示。

（1）CONFIG_TRANSPARENT_HUGEPAGE：支持透明巨型页。

（2）CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS：总是使用透明巨型页。

（3）CONFIG_TRANSPARENT_HUGEPAGE_MADVISE：只在进程使用madvise(MADV_HUGEPAGE)指定的虚拟地址范围内使用透明巨型页。

（4）CONFIG_TRANSPARENT_HUGE_PAGECACHE：文件系统的页缓存使用透明巨型页。

可以在引导内核的时候通过内核参数开启或关闭透明巨型页。

（1）transparent_hugepage=always

（2）transparent_hugepage=madvise

（3）transparent_hugepage=never

可以在运行过程中开启或关闭透明巨型页。

（1）总是使用透明巨型页。

```
echo always > /sys/kernel/mm/transparent_hugepage/enabled
```

（2）只在进程使用 madvise(MADV_HUGEPAGE) 指定的虚拟地址范围内使用透明巨型页。

```
echo madvise > /sys/kernel/mm/transparent_hugepage/enabled
```

（3）禁止使用透明巨型页。

```
echo never > /sys/kernel/mm/transparent_hugepage/enabled
```

分配透明巨型页失败的时候，页分配器采取什么消除内存碎片的策略？可以配置以下策略。

（1）直接回收页，执行同步模式的内存碎片整理。

```

```

（2）异步回收页，执行异步模式的内存碎片整理。

```

```

（3）只针对madvise(MADV_HUGEPAGE)指定的虚拟内存区域，异步回收页，执行异步模式的内存碎片整理。

```

```

（4）只针对madvise(MADV_HUGEPAGE)指定的虚拟内存区域，直接回收页，执行同步模式的内存碎片整理。这是默认策略。

```

```

（5）不采取任何策略。

```

```



