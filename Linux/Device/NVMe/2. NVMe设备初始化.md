
NVMe 本身是一个块设备, 因此NVMe的驱动也是遵循块设备的驱动架构. 本文通过两部分介绍NVMe的驱动程序, 一部分是操作系统如何创建NVMe块设备, 另外一部分是分析一下NVMe的主要流程, 包括读写流程和管理流程等. 

# 创建NVMe块设备

对于 Linux 的**块设备**来说, 其主要的是通过 `device_add_disk` 或者 `add_disk` 函数(后者是对前者的简单包装)来向操作系统**添加一个设备实例**. 其基本原理就是通过调用该函数, 就会创建在 `/dev` 目录下看到的类似 **sdX** 的块设备. 

NVMe 本身也是块设备，自然也不会跳出这个大框架。

首先从**硬件层面**上，**任何设备**必须通过**某个总线与CPU相连接**，NVMe 则正是通过 **PCIe 总线与CPU相连**。

![2023-02-09-21-26-38.png](./images/2023-02-09-21-26-38.png)

当然，目前NVMe除了可以通过PCIe总线与CPU相连外，还可以通过**其它通道**连接，比如**FC**或者**IB**。后者则是一种将 NVMe 设备从计算节点独立出来的方式，也就是此时 **NVMe** 就不再是一个卡设备，而是一个独立机箱的设备。无论何种方式相连接，其本质是一样等。

然后是操作系统软件层面的内容。硬件的连通性是基础，当硬件已经连通后，就可以在Linux内核层面发现设备，并进行初始化了。软件层面的初始化有两种情况，一种是计算机启动的时候，操作系统会扫描总线上的设备，并完成初始化；另外一种情况是设备在系统启动后连接的，此时需要手动触发扫描的过程。


当 nvme.ko 已经加载完了(注册了nvme driver), 这时候如果有 nvme 盘插入 pcie 插槽, **pci** 会**自动识别**到, 并交给 nvme driver 去处理, 而 **nvme driver** 就是调用 `nvme_probe` 去处理这个新加入的设备.

