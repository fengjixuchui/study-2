
# 参考

书籍: 《LINUX设备驱动程序》第三版

初始化参考链接：linux里的nvme驱动代码分析（加载初始化）, https://blog.csdn.net/panzhenjie/article/details/51581063,  nvme_reset_work()函数后的代码大致相同

IO入口点：NVMe的Linux内核驱动分析, https://zhuanlan.zhihu.com/p/72234187

块设备层相关数据结构：Block multi-queue 架构解析（一）数据结构, https://blog.csdn.net/qq_32740107/article/details/106302376

> Linux块设备层已逐步切换到multiqueue , Linux5.0以后单队列代码已被完全移除。multiqueue核心思路是为每个CPU分配一个软件队列，为存储设备的每个硬件队列分配一个硬件派发队列，再将软件队列与硬件派发队列做绑定，减少了IO请求过程中对锁的竞争，从而提高IO性能。

块设备层文档：Block Device Drivers, https://linux-kernel-labs.github.io/refs/heads/master/labs/block_device_drivers.html#block-device-drivers

linux内核源码分析 - nvme设备的初始化, https://www.cnblogs.com/tolimit/p/8779876.html

其他博客:

手把手教Linux驱动: https://blog.csdn.net/daocaokafei/article/details/108071589

linux驱动开发: https://www.cnblogs.com/xiaojiang1025/category/918665.html

nvme kernel driver 阅读笔记: https://www.dazhuanlan.com/karenchan/topics/1006006

nvme协议详解: https://www.zhihu.com/column/c_1338070478725480449

# 源代码阅读顺序

1. `nvme_core` 模块初始化

`nvme_core_init()`:创建工作队列，类；申请设备号

2. nvme 模块初始化

`nvme_init()`:注册 `pci_driver` 结构体

3. nvme 设备初始化

`nvme_probe()`: 加载 nvme 设备

* `nvme_dev_map()`: 申请 IO 内存并进行映射

* `nvme_setup_prp_pools()`: 创建DMA池

* `nvme_init_ctrl()`: 填充 `nvme_ctrl` 结构体，创建字符设备

* `nvme_reset_ctrl()`: 修改 `nvme_ctrl` 结构体状态，将 `nvme_reset_work` 加入工作队列 `nvme_reset_wq`

4. nvme 设备重启

`nvme_reset_work()`: 重启设备，涉及许多nvme协议相关知识，还有设备各阶段对寄存器的操作

* `nvme_dev_disable(dev, false)`: 如果 controller 是 live 的, disable 掉 nvme

* `nvme_pci_enable()`: 初始化 pci 设备（BAR 寄存器，`MSI-X` 中断，CMB 等)

* `nvme_pci_configure_admin_queue()`: 映射 bar 寄存器，申请并初始化 admin 队列

* `nvme_alloc_admin_tags()`: 初始化 `dev->admin_tagset` 结构体，并创建请求队列

* `nvme_init_identify()`: 向 NVMe 设备发送 identify 命令

* `nvme_setup_io_queues()`: 向 NVMe 设备发送 set feature 命令，再次申请中断号，注册中断函数 申请空间，创建 IO 队列

* `nvme_dev_add()`: 填充 `dev->tagset` 

* `nvme_start_ctrl()` -> `nvme_queue_scan()` -> `ctrl->scan_work->nvme_scan_work()`: 

5. 创建块设备

`nvme_scan_work()`: 发送一系列 identify 命令，创建块设备

* 只需看 `nvme_scan_ns_list()` -> `nvme_validate_ns()` -> `nvme_alloc_ns()`

* nvme_alloc_ns(): 填充 ns，创建块设备




# reference


NVMe驱动学习记录-2: https://blog.csdn.net/freedom1523646952/article/details/124734309

