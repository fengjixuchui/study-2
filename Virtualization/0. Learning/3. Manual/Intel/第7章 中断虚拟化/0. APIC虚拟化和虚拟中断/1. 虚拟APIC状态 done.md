
VIRTUAL APIC STATE

`virtual-APIC page`是一个4 KB的内存区域, 处理器用于虚拟化对APIC寄存器的某些访问并管理虚拟中断.  `virtual-APIC page`的物理地址是virtual-APIC address, VMCS中的64位VM执行控制字段(请参见第24.6.8节). 

根据某些`VM-execution controls`的设置, 处理器可以使用类似于local APIC执行的功能来虚拟化virtual-APIC page上的某些字段.  第29.1.1节确定并定义了这些字段.  第29.1.2节, 第29.1.3节, 第29.1.4节和第29.1.5节详细介绍了虚拟化对其中某些字段的更新所采取的措施. 

除了与虚拟APIC寄存器(在第29.1.1节中定义)相对应的字段之外, 软件可以在VMX非根操作中修改逻辑处理器的当前VMCS引用的virtual-APIC page.  (这是第24.11.4节中给出的一般要求的例外. )

# 虚拟APIC寄存器: Virtualized APIC Registers

根据某些VM执行控件的设置, 逻辑处理器可以使用virtual-APIC页面上的以下字段来虚拟化对APIC寄存器的某些访问: 

•虚拟任务优先级寄存器(VTPR): 虚拟APIC页面上偏移080H处的32位字段. 
•虚拟处理器优先级寄存器(VPPR): 虚拟APIC上位于偏移量0A0H的32位字段
页. 
•虚拟中断结束寄存器(VEOI): 位于virtual-APIC页面上偏移量0B0H的32位字段. 
•虚拟中断服务寄存器(VISR): 256位值, 包含8个非连续的32位字段, 在虚拟APIC页面上的偏移量为100H, 110H, 120H, 130H, 140H, 150H, 160H和170H.  VISR的位x在偏移(100H |((x＆E0H)»1))的位位置(x＆1FH). 处理器仅使用偏移量为100H, 110H, 120H, 130H, 140H, 150H, 160H和170H的每个16字节字段的低4字节. 
•虚拟中断请求寄存器(VIRR): 包含8个非连续的32位字段的256位值, 在虚拟APIC页面上的偏移量为200H, 210H, 220H, 230H, 240H, 250H, 260H和270H.  VIRR的位x在偏移(200H |((x＆E0H)»1))的位位置(x＆1FH). 处理器仅使用每个16字节字段的低4字节, 其偏移量为200H, 210H, 220H, 230H, 240H, 250H, 260H和270H. 
•虚拟中断命令寄存器(VICR_LO): 位于virtual-APIC页面上偏移量300H的32位字段
•虚拟中断命令寄存器(VICR_HI): 位于virtual-APIC页面上偏移量310H处的32位字段. 

每当“使用TPR影子” VM执行控制为1时, VTPR字段就会虚拟化TPR. 上面提到的其他字段只要“虚拟中断传送” VM执行控制为1时就会虚拟化相应的APIC寄存器. 

