
在使能SMMU情况下:

* 设备通过SMMU访问内存，在访问之前，须建立起设备访问地址即IOVA到物理内存地址PA之间的映射（保存在内存中）, 此过程称为DMA MAP过程;

* 后续设备需要访问时SMMU自动将设备发送的IOVA转化为PA，当不需要再访问时取消之前建立的映射，此过程称为DMA UNMAP过程。若在没有建立映射前对物理内存进行访问，产生缺页中断。

# DMA MAP过程

DMA MAP 过程基本上分为如下过程：

![2022-08-14-00-27-54.png](./images/2022-08-14-00-27-54.png)

1. 分配需要映射的物理内存；
2. 根据RCACE缓存机制分配IOVA；
3. 根据TTBR及IOVA，建立页表项，建立IOVA与PA之间的映射；
4. 默认在SMMU硬件内部TLB中会缓存IOVA到PA的映射，设备访问对应IOVA时首先从TLB缓存中取，若失败，根据IOVA一级一级查找页表（内存），若没有找到，产生缺页中断；

对于不同的DMA MAP接口，物理内存的组织方式不一样（PA与VA之间映射不同），但整体映射过程基本类似。

# DMA UNMAP过程

DMA UNMAP过程如下：

![2022-08-14-00-29-13.png](./images/2022-08-14-00-29-13.png)




https://blog.csdn.net/flyingnosky/article/details/116770780