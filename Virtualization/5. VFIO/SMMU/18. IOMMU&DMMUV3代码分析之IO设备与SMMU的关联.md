
前面介绍了SMMU设备的生成和识别，但IO设备是如何与SMMU设备关联的呢？一个SMMU设备下面可能有多个IO设备，但每个IO设备只在一个SMMU设备下。

根据驱动设备模型，当IO设备与IO驱动匹配时，会触发IO驱动的probe函数，在其实在调用驱动probe()之前，会调用与IOMMU相关的函数。其过程如下：

![2022-08-16-20-17-48.png](./images/2022-08-16-20-17-48.png)

整个匹配的probe过程中执行的内容较多，这里仅介绍红色部分，即我们关心的DMA相关的设置和设备驱动的probe()（对于IO设备来説，它为IO设备驱动的probe()函数，注意并不是SMMU设备驱动的probe()）。

其中dev->bus->dma_configure()则是本节的重点，它负责将IO设备与SMMU设备关联起来，可见该操作在IO设备的probe()函数之前完成。

对于platform device，dma_configure的回调函数为platform_dma_configure()；对于PCIE设备，dma_configure的回调函数为pci_dma_configure()。但两者最终都调用都一样。

![2022-08-16-20-18-47.png](./images/2022-08-16-20-18-47.png)

暂只介绍ACPI方式的DMA配置acpi_dma_confiugre()。

![2022-08-16-20-19-12.png](./images/2022-08-16-20-19-12.png)

这里主要作如下三个操作：

1. 函数acpi_arch_dma_setup()返回设备支持DMA大小，对于ARM64上来説，默认为48bit大小；
2. 函数acpi_iommu_configure_id()获取设备以及对应的SMMU相关的配置如iommu_ops，并probe设备建立dma_domain；后面重点讲解函数iommu_probe_device();
3. 函数arch_setup_dma_ops()主要对dma_domain分配并初始化IOVA domain；

其中函数iommu_probe_device()是关联IO设备和SMMU设备的关键函数，它为IO设备分配iommu_device，同时为IO设备分配iommu_group，将IO设备对应在iommu_device加入到iommu_group中。

在介绍该函数前简单介绍下重要的结构体iommu_ops和几个概念。

# 结构体iommu_ops

结构体iommu_ops定义了底层硬件对应的回调函数，对于SMMU或INTEL IOMMU都会基于硬件定义自己的iommu_ops。结构体iommu_ops各成员函数定义和描述如下所示，这里仅作简单介绍：




https://blog.csdn.net/flyingnosky/article/details/122569224

https://blog.csdn.net/flyingnosky/article/details/122569919

