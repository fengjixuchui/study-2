
定义的 drhd 链表

```cpp
// drivers/iommu/intel/dmar.c
LIST_HEAD(dmar_drhd_units);
```

探测 intel_iommu 时候

```cpp
// drivers/iommu/intel/dmar.c
IOMMU_INIT_POST(detect_intel_iommu);

int __init detect_intel_iommu()
{
    // iommu 的初始化函数
#ifdef CONFIG_X86
    x86_init.iommu.iommu_init = intel_iommu_init;
    x86_platform.iommu_shutdown = intel_iommu_shutdown;
#endif
}
```

然后在 PCI 子系统初始化以后, 会初始化 iommu

```cpp
// arch/x86/kernel/pci-dma.c
static int __init pci_iommu_init(void)
{
    x86_init.iommu.iommu_init();
}
/* Must execute after PCI subsystem */
// PCI 子系统初始化以后
rootfs_initcall(pci_iommu_init);

#define rootfs_initcall(fn)		__define_initcall(fn, rootfs)
```



```cpp
// drivers/iommu/intel/iommu.c
intel_iommu_init() ->
// drivers/iommu/intel/irq_remapping.c
intel_prepare_irq_remapping() ->


// drivers/iommu/intel/dmar.c
dmar_table_init() ->
parse_dmar_table() ->
dmar_parse_one_drhd() ->
dmar_register_drhd_unit()
```
