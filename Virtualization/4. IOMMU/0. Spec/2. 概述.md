

# Intel虚拟化技术

Intel® VT 由支持基于 Intel® 处理器的平台虚拟化的技术组件组成.

# VMM和VM

Intel VT 对虚拟机架构的支持主要包括两类软件:

* Virtual-Machine Monitor(VMM): VMM 充当主机，并完全控制处理器和其他平台硬件。VMM 为来宾软件（见下文）提供了虚拟处理器的抽象，并允许它直接在逻辑处理器上执行。VMM 能够保留对处理器资源、物理内存、中断管理和 I/O 的选择性控制。
* Guest Software: 虚拟机中运行的软件(Guest OS + APP)

# 处理器虚拟化的硬件支持

VMX

# I/O虚拟化

VMM 必须支持来自 guest software 的 I/O requests.

VMM可以通过下面几种模型来支持 I/O 虚拟化:

* Emulation(I/O 仿真模型): 纯粹软件模拟， 比如e1000模拟的网卡. VMM 可以通过模拟现有（传统）I/O 设备将虚拟设备公开给来​​宾软件。 VMM 在物理平台上可用的任何物理设备上以软件模拟 I/O 设备的功能。通过仿真实现的 I/O 虚拟化提供了良好的兼容性（通过允许现有设备驱动进程在来宾中运行），但对性能和功能造成了限制。

* New Software Interfaces:  比如 SRIOV

* Assignment(直接分配模型): 直接物理IO 设备分给VM. VMM 可以直接将物理 I/O 设备分配给 VM。在此模型中，分配的 I/O 设备的驱动进程在分配给它的 VM 中运行，并允许直接与设备硬件交互，而 VMM 参与最少或没有。可靠的 I/O 分配需要额外的硬件支持，以确保分配的设备访问是隔离的，并限制为分配的分区拥有的资源。I/O 分配模型还可用于创建一个或多个 I/O 容器分区，这些分区支持仿真或软件接口，用于虚拟化来自其他来宾的 I/O 请求。基于 I/O 容器的方法消除了将物理设备驱动进程作为 VMM 特权软件的一部分运行的需要。

* I/O Device Sharing(I/O 设备共享模型): IO设备共享，SRIOV/SIOV. 在此模型（对直接分配模型的扩展）中，I/O 设备支持多个 function 接口，每个 function 接口都可以独立分配给 VM。设备硬件本身能够通过这些功能接口接受多个 I/O 请求，并利用设备的硬件资源处理它们。

根据使用要求，VMM 可能支持 I/O 虚拟化的任何上述模型。例如，I/O 仿真可能最适合虚拟化旧设备。在 Guest 中托管 I/O 密集型工作负载时，I/O 分配可以提供最佳性能。 使用新的软件接口需要在兼容性和性能之间进行权衡，并且设备 I/O 共享提供的虚拟设备数量多于平台中的物理设备数量。

# 虚拟化技术for Directed I/O

上述所有 I/O 虚拟化模型的一般要求是能够**隔离和限制设备对资源的访问**。

用于 Directed I/O 的英特尔® VT 为 VMM 软件提供以下功能：

* I/O device assignment: 用于灵活地将 I/O 设备分配给虚拟机，并扩展虚拟机的保护和隔离属性以进行 I/O 操作。

* DMA remapping: 来自设备的 DMA 地址转换

* Interrupt remapping: 隔离并路由中断(来自设备和外部中断控制器)到相应的 VM.

* Interrupt posting: 将虚拟中断(来自设备和外部中断控制器)**直接投递**到**虚拟处理器**。

* Reliability: 用于记录和报告 DMA 和中断的错误给系统软件，否则可能会损坏(corrupt)内存或影响(impact)虚拟机隔离

## DMA Remapping的硬件支持

处于通用性考虑, 将平台上隔离环境(host物理内存的子集)的抽象称为 domain.

DMA-remapping 硬件会截获设备对系统内存的访问，利用页表，决定访问是不是不允许，以及访问的实际位置。

常用的分页结构可以缓存在硬件中。 DMA重新映射可以为每个设备独立配置，也可以跨多个设备共同配置。

### 操作系统用法

操作系统可以通过多种方式使用 DMA 重新映射:

* **操作系统保护**：操作系统可以定义一个 **domain**, 包含**关键代码**和**数据结构**，并**限制**系统中**所有 I/O 设备**对该 domain 的访问。如果**设备驱动**程序**对设备进行不正确的编程**, 这个 domain 允许**操作系统限制**其数据和代码的错误或意外损坏，从而提高了操作系统的健壮性和可靠性。

* **功能支持**：操作系统可以使用 domain 来更好地管理从**旧版设备**对**高地址内存的 DMA**（例如，32位PCI设备要访问4GB以上内存）。 这是通过对 I/O 页表进行编程以将DMA从这些设备重新映射到高内存来实现的。 没有这样的支持，软件就必须通过OS的“反弹缓冲区（bounce buffers）”来复制数据。

* **DMA隔离**(DMA Isolation)：OS 可以通过创建**多个 domain** 来管理 I/O, 并**将一个或多个 I/O 设备分配给每个域**。每个设备驱动程序都会在 OS 中显式注册其 I/O buffers，然后 OS 会借用硬件实行 DMA 域的保护，从而将这些 I/O buffers 分配给特定的domain。请参见图2-1。

![2022-11-07-09-32-01.png](./images/2022-11-07-09-32-01.png)

* **共享虚拟内存**(Shared Virtual Memory, SVM)：对于支持 PCIe PASID(Process Address Space ID, 进程地址空间ID)功能的设备，操作系统可以使用DMA重映射硬件​​功能让 **I/O 设备共享应用程序进程的虚拟地址空间**。SVM 以及对 I/O page-faults 的支持，使**应用程序**可以将**任意数据结构**自由地传递到 GPU 或 accelerators 等**设备**，从而减少数据 pinning 和 marshalling 的开销。

### VMM用法

DMA Remapping 的硬件支持可实现设备直接分配, 而无需在 VMM 中知道设备的相关信息. I/O 设备的驱动进程仅仅在分配给它的 partition 中运行, 并且可以直接和设备交互, 而无需或者 VMM 的最少参与（配置空间和中断管理）。

![2022-11-07-11-52-06.png](./images/2022-11-07-11-52-06.png)

在此模型中，VMM 将直通设备限制为特定分区。仅当 **guest** 软件**访问影响系统功能和隔离的受保护资源**（例如**配置访问**、**中断管理**等）时才调用 **VMM**，而不是为来自分区的所有 I/O 请求调用 VMM。

为了支持直接分配 I/O 设备，VMM 必须强制隔离 DMA 请求。可以将 I/O 设备分配给 domain，并且可以使用重映射硬件​​将 DMA 从 I/O 设备限制到其域当前拥有的物理内存。对于可能在物理内存中重新定位的域，可以对重新映射硬件进行编程以执行必要的转换。 

I/O 设备分配允许其他 I/O 共享使用——例如，将 I/O 设备分配给一个 I/O 分区，该 I/O 分区为其他用户分区提供 I/O 服务。重新映射硬件使虚拟化软件能够选择设备分配和基于软件的 I/O 虚拟化方法的正确组合。


IO设备分配，可以IO共享。一个IO分区的设备，可以给其他分区提供分享。





### Guest用法

