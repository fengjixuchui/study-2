
定义的 drhd 链表

```cpp
// drivers/iommu/intel/dmar.c
LIST_HEAD(dmar_drhd_units);
```

探测 intel_iommu 时候

```cpp
// drivers/iommu/intel/dmar.c
IOMMU_INIT_POST(detect_intel_iommu);

int __init detect_intel_iommu()
{
    // iommu 的初始化函数
#ifdef CONFIG_X86
    x86_init.iommu.iommu_init = intel_iommu_init;
    x86_platform.iommu_shutdown = intel_iommu_shutdown;
#endif
}
```

然后在 PCI 子系统初始化以后, 会初始化 iommu

```cpp
// arch/x86/kernel/pci-dma.c
static int __init pci_iommu_init(void)
{
    x86_init.iommu.iommu_init();
}
/* Must execute after PCI subsystem */
// PCI 子系统初始化以后
rootfs_initcall(pci_iommu_init);

#define rootfs_initcall(fn)		__define_initcall(fn, rootfs)
```

在 iommu 初始化或者 irq remapping 初始化时候, 会对 dmar table 进行初始化

```cpp
// drivers/iommu/intel/iommu.c
intel_iommu_init() ->
// drivers/iommu/intel/irq_remapping.c
intel_prepare_irq_remapping() ->


// drivers/iommu/intel/dmar.c
// dmar table 初始化
dmar_table_init() ->
// 解析 DMA reporting table
parse_dmar_table()
```

```cpp
// drivers/iommu/intel/dmar.c
struct acpi_table_header * __initdata dmar_tbl;

static int __init
parse_dmar_table(void)
{
    struct acpi_table_dmar *dmar;
    // 探测 dmar table
	dmar_table_detect();

	dmar_tbl = tboot_get_dmar_table(dmar_tbl);

    dmar = (struct acpi_table_dmar *)dmar_tbl;

}
```

其中:

* `struct acpi_table_header` 是通用 ACPI 表的表头的数据结构

* `struct acpi_table_dmar` 就是 DMAR 表的数据结构

```cpp
// include/acpi/actbl.h
// 通用的 ACPI 表的头部
struct acpi_table_header {
	char signature[ACPI_NAMESEG_SIZE];	// APCI 表签名
	u32 length;		// 表的长度(字节), 包括该通用表头和具体表
	u8 revision;		// ACPI 规范次要版本号
	u8 checksum;		// 整个表的总和必须为 0, 包括该通用表头和具体表
	char oem_id[ACPI_OEM_ID_SIZE];	// ASCII 原始设备制造商标识
	char oem_table_id[ACPI_OEM_TABLE_ID_SIZE];	// ASCII OEM 表标识
	u32 oem_revision;	// OEM 修订号
	char asl_compiler_id[ACPI_NAMESEG_SIZE];	// 供应商 ID
	u32 asl_compiler_revision;	// 供应商 修订号
};

// DMAR 表
struct acpi_table_dmar {
	struct acpi_table_header header;	// 通用的 ACPI 表头
	u8 width;		// 最大 DMA 物理可寻址能力(也就是 host 地址宽度)
	u8 flags;       // 标识
	u8 reserved[10];    // 保留位
};
```



```cpp
dmar_walk_dmar_table() ->
dmar_parse_one_drhd() ->
dmar_register_drhd_unit()
```
